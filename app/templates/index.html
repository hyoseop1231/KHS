<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KITECH RAG Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>KITECH RAG Chatbot</h1>

        <div class="ollama-section">
            <h2>ì‹œìŠ¤í…œ ìƒíƒœ ëŒ€ì‹œë³´ë“œ</h2>
            
            <!-- ì²« ë²ˆì§¸ ì¤„: Ollama & ëª¨ë¸ ì„ íƒ (ê· ë“± ë°°ì¹˜) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 15px;">
                <!-- Ollama ìƒíƒœ -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="ollama-status" style="font-size: 0.95em;">Ollama ìƒíƒœ: í™•ì¸ ì¤‘...</div>
                </div>
                
                <!-- ëª¨ë¸ ì„ íƒ -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="ollama-models" style="margin: 0; white-space: nowrap; font-size: 0.95em;">ëª¨ë¸:</label>
                    <select id="ollama-models" style="flex: 1; min-width: 0;">
                        <option value="">ë¡œë”© ì¤‘...</option>
                    </select>
                </div>
                
                <!-- ëª¨ë¸ ì •ë³´ & ì‘ë™ ìƒíƒœ -->
                <div id="model-info-container" style="display: flex; align-items: center; gap: 12px;">
                    <div id="model-info" style="font-size: 0.85em; color: #495057; flex: 1; min-width: 0;">
                        ëª¨ë¸ ì •ë³´ ë¡œë”© ì¤‘...
                    </div>
                    <div id="model-activity" style="display: none; align-items: center; gap: 8px;">
                        <div id="activity-gauge" style="width: 20px; height: 20px; border-radius: 50%; background: conic-gradient(#28a745 0deg, #e9ecef 0deg); position: relative; transition: all 0.3s ease;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: white; border-radius: 50%;"></div>
                        </div>
                        <span id="activity-text" style="font-size: 0.8em; color: #28a745; font-weight: 500;">ëŒ€ê¸°ì¤‘</span>
                    </div>
                </div>
            </div>
            
            <!-- ë‘ ë²ˆì§¸ ì¤„: ì‹œìŠ¤í…œ í†µê³„ & ë¹ ë¥¸ ì„¤ì • -->
            <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                <!-- ì‹œìŠ¤í…œ í†µê³„ -->
                <div style="display: flex; gap: 20px; flex: 1; min-width: 300px;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #495057;" id="doc-count">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">ë¬¸ì„œ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #495057;" id="chunk-count">0</div>
                        <div style="font-size: 0.8em; color: #6c757d;">ì²­í¬</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: 600; color: #495057;" id="storage-size">0MB</div>
                        <div style="font-size: 0.8em; color: #6c757d;">ì €ì¥ê³µê°„</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.9em; font-weight: 500; color: #6c757d;" id="last-update">ì—…ë°ì´íŠ¸ ì—†ìŒ</div>
                        <div style="font-size: 0.8em; color: #6c757d;">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                    </div>
                </div>
                
                <!-- ë¹ ë¥¸ ì„¤ì • í† ê¸€ -->
                <div style="display: flex; gap: 15px; align-items: center; border-left: 1px solid #dee2e6; padding-left: 20px;">
                    <label style="display: flex; align-items: center; gap: 5px; margin: 0; font-size: 0.9em; cursor: pointer;">
                        <input type="checkbox" id="ocr-correction-toggle" checked style="margin: 0;">
                        <span>OCR êµì •</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; margin: 0; font-size: 0.9em; cursor: pointer;">
                        <input type="checkbox" id="llm-correction-toggle" checked style="margin: 0;">
                        <span>LLM êµì •</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; margin: 0; font-size: 0.9em; cursor: pointer;">
                        <input type="checkbox" id="auto-refresh-toggle" checked style="margin: 0;">
                        <span>ìë™ìƒˆë¡œê³ ì¹¨</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <h2>ë¬¸ì„œ ì—…ë¡œë“œ ë° ì²˜ë¦¬</h2>
            <form id="upload-form">
                <label for="pdf-file">PDF ì„ íƒ:</label>
                <input type="file" id="pdf-file" name="files" accept=".pdf" multiple required>
                
                <!-- ì„ íƒëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ -->
                <div id="selected-files-container" style="display:none; margin-top:15px;">
                    <h4 style="margin: 10px 0; color: #495057;">ì„ íƒëœ íŒŒì¼ ëª©ë¡:</h4>
                    <div id="selected-files-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                        <!-- ì„ íƒëœ íŒŒì¼ë“¤ì´ ì—¬ê¸°ì— ì²´í¬ë°•ìŠ¤ì™€ í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <button type="button" id="select-all-btn" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em;">ì „ì²´ ì„ íƒ</button>
                        <button type="button" id="deselect-all-btn" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em;">ì „ì²´ í•´ì œ</button>
                        <span id="selected-count" style="font-size: 0.9em; color: #6c757d;">0ê°œ íŒŒì¼ ì„ íƒë¨</span>
                    </div>
                </div>
                
                <button type="submit" id="upload-submit-btn">ì—…ë¡œë“œ ë° ì²˜ë¦¬</button>
            </form>
            <div id="upload-status" class="status-message"></div>
            <div id="progress-container" style="display:none; margin-top:15px; border:1px solid #ddd; border-radius:8px; padding:15px; background:#f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #495057;">íŒŒì¼ ì²˜ë¦¬ ì§„í–‰ ìƒí™©</h4>
                    <button id="hide-progress" style="background: none; border: none; font-size: 1.2em; cursor: pointer; color: #6c757d;" title="ì§„í–‰ë¥  ì°½ ìˆ¨ê¸°ê¸°">âœ•</button>
                </div>
                
                <!-- ì „ì²´ ì§„í–‰ë¥  -->
                <div id="overall-progress" style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span id="overall-progress-text">ì „ì²´ ì§„í–‰ë¥ </span>
                        <span id="overall-progress-count">0/0 ì™„ë£Œ</span>
                    </div>
                    <div style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                        <div id="overall-progress-bar" style="height:100%; width:0%; background:#28a745; transition:width 0.3s;"></div>
                    </div>
                </div>
                
                <!-- ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  ì»¨í…Œì´ë„ˆ -->
                <div id="individual-progress-container">
                    <!-- ê°œë³„ íŒŒì¼ ì§„í–‰ë¥ ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <!-- ì™„ë£Œ í›„ ìë™ ìˆ¨ê¹€ ì„¤ì • -->
                <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d; text-align: center;">
                    <label>
                        <input type="checkbox" id="auto-hide-progress" checked style="margin-right: 5px;">
                        ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸° (10ì´ˆ í›„)
                    </label>
                </div>
            </div>
        </div>

        <div class="document-management-section">
            <h2>ë¬¸ì„œ ê´€ë¦¬ 
                <span id="auto-refresh-indicator" style="font-size: 0.8em; color: #28a745; margin-left: 10px;">
                    ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±í™”
                </span>
            </h2>
            <div style="margin-bottom:15px;">
                <button id="refresh-documents" style="margin-right:10px;">ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <button id="storage-stats" style="margin-right:10px;">ì €ì¥ì†Œ í†µê³„</button>
                <button id="cleanup-files" style="margin-right:10px;">ê³ ì•„ íŒŒì¼ ì •ë¦¬</button>
                <button id="delete-all-documents" style="background:#dc3545; color:white;">ëª¨ë“  ë¬¸ì„œ ì‚­ì œ</button>
            </div>
            
            <div id="document-list" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <!-- ë¬¸ì„œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div id="management-status" class="status-message"></div>
        </div>

        <div class="chat-section">
            <h2>ì±—ë´‡ê³¼ ëŒ€í™”í•˜ê¸°</h2>
            <div style="margin-bottom:10px;">
                <label>ë¬¸ì„œ ì„ íƒ:</label>
                <div id="chat-docs-container" style="margin-top:5px;">
                    <div>
                        <input type="checkbox" id="select-all-docs" checked>
                        <label for="select-all-docs" style="font-weight:600;">ì „ì²´ ë¬¸ì„œ</label>
                    </div>
                    <div id="individual-doc-checkboxes" style="max-height:120px; overflow-y:auto; margin-top:5px; padding-left:10px; border-left:2px solid #ccc;">
                        <!-- ê°œë³„ ë¬¸ì„œ ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤íŠ¸ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <span id="document-info" style="display:block; font-size:0.95em; color:#666; margin-top:4px;"></span>
            </div>
            
            <!-- Chat Progress Indicator -->
            <div id="chat-progress" class="chat-progress">
                <div class="chat-progress-steps">
                    <div class="progress-step" data-step="query">
                        <div class="progress-step-icon" data-step="1"></div>
                        <span>ì§ˆë¬¸ ë¶„ì„</span>
                    </div>
                    <div class="progress-step" data-step="embedding">
                        <div class="progress-step-icon" data-step="2"></div>
                        <span>ì„ë² ë”© ìƒì„±</span>
                    </div>
                    <div class="progress-step" data-step="search">
                        <div class="progress-step-icon" data-step="3"></div>
                        <span>ë¬¸ì„œ ê²€ìƒ‰</span>
                    </div>
                    <div class="progress-step" data-step="generate">
                        <div class="progress-step-icon" data-step="4"></div>
                        <span>ë‹µë³€ ìƒì„±</span>
                    </div>
                </div>
                <div class="progress-message" id="chat-progress-message">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
            
            <div id="chat-history">
                <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="send-button" class="btn btn-primary">ğŸ’¬ ì „ì†¡</button>
            </div>
            <div id="chat-status" class="status-message"></div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const pdfFile = document.getElementById('pdf-file');
        const uploadStatus = document.getElementById('upload-status');

        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatStatus = document.getElementById('chat-status');

        // íŒŒì¼ ì„ íƒ ìƒíƒœ ê´€ë¦¬
        let selectedFilesForUpload = new Set();
        
        // íŒŒì¼ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        pdfFile.addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            displaySelectedFiles(files);
        });
        
        // ì„ íƒëœ íŒŒì¼ ëª©ë¡ í‘œì‹œ
        function displaySelectedFiles(files) {
            const container = document.getElementById('selected-files-container');
            const filesList = document.getElementById('selected-files-list');
            const selectedCount = document.getElementById('selected-count');
            
            if (files.length === 0) {
                container.style.display = 'none';
                selectedFilesForUpload.clear();
                return;
            }
            
            container.style.display = 'block';
            selectedFilesForUpload.clear();
            
            filesList.innerHTML = '';
            files.forEach((file, index) => {
                selectedFilesForUpload.add(index); // ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  íŒŒì¼ ì„ íƒ
                
                const fileItem = document.createElement('div');
                fileItem.style.cssText = `
                    display: flex; 
                    align-items: center; 
                    padding: 8px 12px; 
                    margin-bottom: 6px; 
                    background: white; 
                    border: 1px solid #dee2e6; 
                    border-radius: 6px;
                    transition: all 0.2s ease;
                `;
                
                fileItem.innerHTML = `
                    <input type="checkbox" id="file-${index}" checked style="margin-right: 10px;">
                    <label for="file-${index}" style="flex: 1; margin: 0; cursor: pointer; font-size: 0.9rem;">
                        ğŸ“„ ${file.name}
                    </label>
                    <span style="font-size: 0.8rem; color: #6c757d;">
                        ${(file.size / 1024 / 1024).toFixed(2)} MB
                    </span>
                `;
                
                const checkbox = fileItem.querySelector(`#file-${index}`);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedFilesForUpload.add(index);
                        fileItem.style.backgroundColor = 'white';
                    } else {
                        selectedFilesForUpload.delete(index);
                        fileItem.style.backgroundColor = '#f8f9fa';
                    }
                    updateSelectedCount();
                });
                
                filesList.appendChild(fileItem);
            });
            
            updateSelectedCount();
        }
        
        // ì„ íƒëœ íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            const selectedCount = document.getElementById('selected-count');
            const submitBtn = document.getElementById('upload-submit-btn');
            
            selectedCount.textContent = `${selectedFilesForUpload.size}ê°œ íŒŒì¼ ì„ íƒë¨`;
            submitBtn.disabled = selectedFilesForUpload.size === 0;
            
            if (selectedFilesForUpload.size === 0) {
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            } else {
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
            }
        }
        
        // ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
        document.getElementById('select-all-btn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#selected-files-list input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = true;
                selectedFilesForUpload.add(index);
                checkbox.closest('div').style.backgroundColor = 'white';
            });
            updateSelectedCount();
        });
        
        document.getElementById('deselect-all-btn').addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('#selected-files-list input[type="checkbox"]');
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = false;
                selectedFilesForUpload.delete(index);
                checkbox.closest('div').style.backgroundColor = '#f8f9fa';
            });
            updateSelectedCount();
        });

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘ ì‹œ management ë©”ì‹œì§€ í´ë¦¬ì–´
            if (typeof clearManagementStatus === 'function') {
                clearManagementStatus();
            }
            
            uploadStatus.textContent = 'ì„ íƒëœ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
            
            const allFiles = Array.from(pdfFile.files);
            const selectedFiles = allFiles.filter((file, index) => selectedFilesForUpload.has(index));
            
            if (selectedFiles.length === 0) {
                uploadStatus.textContent = 'ì²˜ë¦¬í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
                return;
            }
            
            const formData = new FormData();
            for (const f of selectedFiles) {
                formData.append('files', f);
            }
            // Include OCR correction flag from dashboard toggle
            const ocrToggle = document.getElementById('ocr-correction-toggle');
            formData.append('ocr_correction_enabled', ocrToggle.checked);
            
            // Include LLM correction flag from dashboard toggle
            const llmToggle = document.getElementById('llm-correction-toggle');
            formData.append('llm_correction_enabled', llmToggle.checked);
            try {
                const response = await fetch('/api/upload_pdf/', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (response.ok) {
                    if (result.results && Array.isArray(result.results)) {
                        const successfulUploads = [];
                        const errorUploads = [];
                        
                        for (const r of result.results) {
                            if (r.error) {
                                errorUploads.push({filename: r.filename || 'íŒŒì¼ ì—†ìŒ', error: r.error});
                            } else {
                                if(r.document_id) {
                                    successfulUploads.push({
                                        documentId: r.document_id,
                                        filename: r.filename
                                    });
                                }
                            }
                        }
                        
                        // ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš°ë§Œ ë©”ì‹œì§€ í‘œì‹œ
                        if (errorUploads.length > 0) {
                            let errorMsg = '';
                            errorUploads.forEach(error => {
                                errorMsg += `âŒ ${error.filename}: ${error.error}\n`;
                            });
                            uploadStatus.textContent = errorMsg.trim();
                            uploadStatus.className = 'status-message status-error';
                        } else {
                            // ì„±ê³µí•œ ê²½ìš° ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ
                            uploadStatus.textContent = `${successfulUploads.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘ë¨`;
                            uploadStatus.className = 'status-message status-success';
                        }
                        
                        // ë‹¤ì¤‘ íŒŒì¼ ì§„í–‰ë¥  ì¶”ì  ì‹œì‘
                        if (successfulUploads.length > 0) {
                            startMultiFileProgressTracking(successfulUploads);
                            
                            // ì„±ê³µ ë©”ì‹œì§€ë¥¼ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
                            setTimeout(() => {
                                uploadStatus.textContent = '';
                                uploadStatus.className = 'status-message';
                            }, 3000);
                        }
                        
                        // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            fetchDocumentList();
                        }, 2000);
                    } else {
                        uploadStatus.textContent = 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ í˜•ì‹';
                        uploadStatus.className = 'status-message status-error';
                    }
                } else {
                    uploadStatus.textContent = `ì˜¤ë¥˜: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    uploadStatus.className = 'status-message status-error';
                }
            } catch (error) {
                uploadStatus.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            }
        });

        async function sendMessage() {
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage('user', query);
            chatInput.value = '';
            
            // Show progress indicator
            showChatProgress();
            
            // ëª¨ë¸ í™œë™ ìƒíƒœë¥¼ 'ì²˜ë¦¬ì¤‘'ìœ¼ë¡œ ë³€ê²½
            updateModelActivity('processing');
            
            // Disable send button
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading-spinner"></span>ìƒì„± ì¤‘...';

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query, model_name: getSelectedModel(), document_ids: getSelectedDocumentIds() }),
                });
                const result = await response.json();
                if (response.ok) {
                    // ë©€í‹°ëª¨ë‹¬ ì»¨í…íŠ¸ê°€ ìˆëŠ” ê²½ìš° ì´ë¯¸ì§€ì™€ í‘œë„ í‘œì‹œ
                    if (result.media_references && result.media_references.has_media) {
                        appendMultimodalMessage('bot', result);
                    } else {
                        appendMessage('bot', result.response, true);
                    }
                    
                    chatStatus.className = 'status-message status-success';
                    
                    // ì‚¬ìš©ëœ ì»¨í…íŠ¸ ìš”ì•½ í‘œì‹œ
                    const summary = result.content_summary;
                    if (summary) {
                        const summaryText = `í…ìŠ¤íŠ¸: ${summary.text_chunks || 0}ê°œ, ì´ë¯¸ì§€: ${summary.images || 0}ê°œ, í‘œ: ${summary.tables || 0}ê°œ`;
                        chatStatus.textContent = `âœ… ë‹µë³€ ìƒì„± ì™„ë£Œ (${summaryText})`;
                    } else {
                        chatStatus.textContent = 'âœ… ë‹µë³€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    }
                    
                    setTimeout(() => {
                        chatStatus.textContent = '';
                        chatStatus.className = 'status-message';
                    }, 5000);
                } else {
                    appendMessage('bot', `âŒ ì˜¤ë¥˜: ${result.detail || 'ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜'}`);
                    chatStatus.className = 'status-message status-error';
                    chatStatus.textContent = `âŒ ì˜¤ë¥˜: ${result.detail || 'ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜'}`;
                }
            } catch (error) {
                appendMessage('bot', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                chatStatus.className = 'status-message status-error';
                chatStatus.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            } finally {
                // Hide progress indicator and re-enable button
                hideChatProgress();
                sendButton.disabled = false;
                sendButton.innerHTML = 'ğŸ’¬ ì „ì†¡';
                
                // ëª¨ë¸ í™œë™ ìƒíƒœë¥¼ 'ëŒ€ê¸°ì¤‘'ìœ¼ë¡œ ë³µê·€
                updateModelActivity('idle');
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(sender, text, isMarkdown=false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            if(isMarkdown && window.marked) {
                messageDiv.innerHTML = window.marked.parse(text);
            } else {
                messageDiv.textContent = text;
            }
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }
        
        function appendMultimodalMessage(sender, result) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'bot-message', 'multimodal-message');
            
            // ë©”ì¸ ë‹µë³€ í…ìŠ¤íŠ¸
            const responseDiv = document.createElement('div');
            responseDiv.classList.add('response-text');
            if (window.marked) {
                responseDiv.innerHTML = window.marked.parse(result.response);
            } else {
                responseDiv.textContent = result.response;
            }
            messageDiv.appendChild(responseDiv);
            
            // ë¯¸ë””ì–´ ì»¨í…íŠ¸ ì¶”ê°€
            if (result.media_references && result.media_references.has_media) {
                const mediaDiv = document.createElement('div');
                mediaDiv.classList.add('media-content');
                
                // ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™”
                // Image display functionality temporarily disabled
                
                // ì°¸ì¡°ëœ í‘œ í‘œì‹œ
                if (result.media_references.tables && result.media_references.tables.length > 0) {
                    const tablesSection = document.createElement('div');
                    tablesSection.classList.add('referenced-tables');
                    tablesSection.innerHTML = '<h4>ğŸ“Š ì°¸ì¡°ëœ í‘œ</h4>';
                    
                    result.media_references.tables.forEach((table, tableIndex) => {
                        const tableContainer = document.createElement('div');
                        tableContainer.classList.add('table-reference');
                        tableContainer.setAttribute('data-table-number', tableIndex + 1);
                        
                        let tableHtml = `
                            <div class="table-info">
                                <span class="media-number">[í‘œ${tableIndex + 1}]</span>
                                <strong>ğŸ“„ ${table.filename}</strong> (í˜ì´ì§€ ${table.page})
                                <small>ì¶œì²˜: ${table.source}</small>
                            </div>
                        `;
                        
                        // í‘œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                        if (table.parsed_data && table.parsed_data.length > 0) {
                            const tableId = `table-${tableIndex}-${Date.now()}`;
                            tableHtml += `
                                <div class="table-data">
                                    <div class="table-controls">
                                        <button class="btn-small" onclick="toggleTableExpand('${tableId}')">ì „ì²´ ë³´ê¸°</button>
                                        <span class="table-size-info">${table.parsed_data.length}í–‰ í‘œ</span>
                                    </div>
                                    <table id="${tableId}" class="data-table collapsed">
                            `;
                            
                            // ì²˜ìŒì—ëŠ” 5í–‰ë§Œ í‘œì‹œ
                            const maxRows = 5;
                            for (let i = 0; i < Math.min(maxRows, table.parsed_data.length); i++) {
                                const row = table.parsed_data[i];
                                if (Array.isArray(row) && row.length > 0) {
                                    tableHtml += '<tr class="visible-row">';
                                    row.forEach((cell, cellIndex) => {
                                        const tag = i === 0 ? 'th' : 'td';
                                        const cellContent = String(cell).length > 50 ? 
                                            String(cell).substring(0, 50) + '...' : cell;
                                        tableHtml += `<${tag} title="${String(cell).replace(/"/g, '&quot;')}">${cellContent}</${tag}>`;
                                    });
                                    tableHtml += '</tr>';
                                }
                            }
                            
                            // ë‚˜ë¨¸ì§€ í–‰ë“¤ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€)
                            for (let i = maxRows; i < table.parsed_data.length; i++) {
                                const row = table.parsed_data[i];
                                if (Array.isArray(row) && row.length > 0) {
                                    tableHtml += '<tr class="hidden-row" style="display: none;">';
                                    row.forEach((cell, cellIndex) => {
                                        const cellContent = String(cell).length > 50 ? 
                                            String(cell).substring(0, 50) + '...' : cell;
                                        tableHtml += `<td title="${String(cell).replace(/"/g, '&quot;')}">${cellContent}</td>`;
                                    });
                                    tableHtml += '</tr>';
                                }
                            }
                            
                            if (table.parsed_data.length > maxRows) {
                                tableHtml += `<tr class="table-expand-indicator"><td colspan="100%" class="table-more">... +${table.parsed_data.length - maxRows}í–‰ ë” ë³´ê¸°</td></tr>`;
                            }
                            
                            tableHtml += '</table></div>';
                        } else if (table.content) {
                            // íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ì»¨í…íŠ¸ í‘œì‹œ
                            tableHtml += `
                                <div class="table-raw-content">
                                    <pre>${table.content}</pre>
                                </div>
                            `;
                        }
                        
                        // í‘œ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì¶”ê°€
                        if (table.path) {
                            const tableImageUrl = `/${table.path}`;
                            tableHtml += `
                                <div class="table-image-preview">
                                    <p><strong>í‘œ ì´ë¯¸ì§€:</strong></p>
                                    <img src="${tableImageUrl}" alt="Table from ${table.filename}" class="preview-table-image" 
                                         onclick="openImageModal('${tableImageUrl}', 'Table from ${table.filename}')" 
                                         onerror="this.style.display='none'">
                                </div>
                            `;
                        }
                        
                        tableContainer.innerHTML = tableHtml;
                        tablesSection.appendChild(tableContainer);
                    });
                    
                    mediaDiv.appendChild(tablesSection);
                }
                
                messageDiv.appendChild(mediaDiv);
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Chat progress functions
        function showChatProgress() {
            const progressEl = document.getElementById('chat-progress');
            const progressMessage = document.getElementById('chat-progress-message');
            const steps = ['query', 'embedding', 'search', 'generate'];
            
            progressEl.classList.add('active');
            
            // Reset all steps
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Simulate progress steps
            let currentStep = 0;
            const stepInterval = setInterval(() => {
                if (currentStep > 0) {
                    const prevStep = document.querySelector(`[data-step="${steps[currentStep-1]}"]`);
                    prevStep.classList.remove('active');
                    prevStep.classList.add('completed');
                }
                
                if (currentStep < steps.length) {
                    const currentStepEl = document.querySelector(`[data-step="${steps[currentStep]}"]`);
                    currentStepEl.classList.add('active');
                    
                    const messages = {
                        'query': 'ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'embedding': 'ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'search': 'ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'generate': 'AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
                    };
                    
                    progressMessage.textContent = messages[steps[currentStep]];
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                }
            }, 800);
            
            // Store interval for cleanup
            progressEl.stepInterval = stepInterval;
        }
        
        function hideChatProgress() {
            const progressEl = document.getElementById('chat-progress');
            
            // Clear interval if running
            if (progressEl.stepInterval) {
                clearInterval(progressEl.stepInterval);
            }
            
            // Mark all steps as completed
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
            });
            
            // Hide after a brief delay
            setTimeout(() => {
                progressEl.classList.remove('active');
            }, 1000);
        }

        // Ollama ìƒíƒœ ë° ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchOllamaStatusAndModels() {
            const statusEl = document.getElementById('ollama-status');
            // ìƒíƒœ
            try {
                const res = await fetch('/api/ollama/status');
                const data = await res.json();
                const status = data.status === 'running' ? 'âœ… ì‹¤í–‰ ì¤‘' : (data.status === 'not running' ? 'âŒ ì¤‘ì§€ë¨' : 'â“ ' + data.status);
                statusEl.textContent = 'Ollama ìƒíƒœ: ' + status;
                statusEl.className = 'status-display ' + (data.status === 'running' ? 'status-running' : 'status-stopped');
            } catch (e) {
                statusEl.textContent = 'Ollama ìƒíƒœ: âŒ í™•ì¸ ì‹¤íŒ¨';
                statusEl.className = 'status-display status-stopped';
            }
            // ëª¨ë¸ ëª©ë¡
            try {
                const res = await fetch('/api/ollama/models');
                const data = await res.json();
                const select = document.getElementById('ollama-models');
                
                // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ ì €ì¥ (ìˆë‹¤ë©´)
                const currentSelected = select.value;
                
                select.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    let gemma3Found = false;
                    let defaultModel = null;
                    
                    data.models.forEach((model, index) => {
                        const opt = document.createElement('option');
                        opt.value = model;
                        opt.textContent = formatModelName(model);
                        select.appendChild(opt);
                        
                        // Gemma3 ëª¨ë¸ ì°¾ê¸° (gemma2ë‚˜ gemmaë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë¸ ìš°ì„  ì„ íƒ)
                        if (!gemma3Found && (model.toLowerCase().includes('gemma2') || model.toLowerCase().includes('gemma'))) {
                            gemma3Found = true;
                            defaultModel = model;
                        }
                        
                        // ì²« ë²ˆì§¸ ëª¨ë¸ì„ ë°±ì—…ìœ¼ë¡œ ì €ì¥
                        if (!defaultModel) {
                            defaultModel = model;
                        }
                        
                        // ì´ì „ì— ì„ íƒëœ ëª¨ë¸ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì„ íƒ
                        if (currentSelected && model === currentSelected) {
                            opt.selected = true;
                        }
                    });
                    
                    // ì´ì „ ì„ íƒì´ ì—†ìœ¼ë©´ Gemma ëª¨ë¸ ë˜ëŠ” ì²« ë²ˆì§¸ ëª¨ë¸ ì„ íƒ
                    if (!currentSelected && defaultModel) {
                        select.value = defaultModel;
                        // í•´ë‹¹ ì˜µì…˜ì„ ì„ íƒ ìƒíƒœë¡œ ë§Œë“¤ê¸°
                        const targetOption = select.querySelector(`option[value="${defaultModel}"]`);
                        if (targetOption) {
                            targetOption.selected = true;
                        }
                    }
                    
                    // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                    updateSelectedModelDisplay();
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'ëª¨ë¸ ì—†ìŒ';
                    select.appendChild(opt);
                }
            } catch (e) {
                const select = document.getElementById('ollama-models');
                select.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                select.appendChild(opt);
            }
        }
        function getSelectedModel() {
            const select = document.getElementById('ollama-models');
            return select.value;
        }
        
        // ëª¨ë¸ëª… ê°„ë‹¨í•˜ê²Œ í¬ë§·
        function formatModelName(fullModelName) {
            if (!fullModelName) return fullModelName;
            
            // ì¼ë°˜ì ì¸ íŒ¨í„´ë“¤ ì²˜ë¦¬
            const patterns = [
                // llama2:7b -> Llama2 (7B)
                { regex: /^(\w+):(\d+\.?\d*b?)$/i, format: (match) => `${capitalize(match[1])} (${match[2].toUpperCase()})` },
                // qwen2:1.5b -> Qwen2 (1.5B)
                { regex: /^(\w+\d*):(\d+\.?\d*b?)$/i, format: (match) => `${capitalize(match[1])} (${match[2].toUpperCase()})` },
                // gemma:2b-instruct -> Gemma (2B-Instruct)
                { regex: /^(\w+):(\d+\.?\d*b?-?\w*)$/i, format: (match) => `${capitalize(match[1])} (${match[2].toUpperCase()})` },
                // llama2:latest -> Llama2 (Latest)
                { regex: /^(\w+):latest$/i, format: (match) => `${capitalize(match[1])} (Latest)` },
                // codellama:13b-code -> CodeLlama (13B-Code)
                { regex: /^(\w+):(\d+\.?\d*b?-?\w*)$/i, format: (match) => `${capitalize(match[1])} (${match[2].toUpperCase()})` },
            ];
            
            for (const pattern of patterns) {
                const match = fullModelName.match(pattern.regex);
                if (match) {
                    return pattern.format(match);
                }
            }
            
            // ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ê²½ìš° ì²« ë²ˆì§¸ ë¶€ë¶„ë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ ì „ì²´ ì´ë¦„ ì‚¬ìš©
            if (fullModelName.includes(':')) {
                const parts = fullModelName.split(':');
                return `${capitalize(parts[0])} (${parts[1]})`;
            }
            
            return capitalize(fullModelName);
        }
        
        // ì²« ê¸€ìë¥¼ ëŒ€ë¬¸ìë¡œ ë³€í™˜
        function capitalize(str) {
            if (!str) return str;
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateSelectedModelDisplay() {
            const select = document.getElementById('ollama-models');
            const selectedModel = select.value;
            
            if (selectedModel) {
                select.style.color = '#495057';
                select.style.fontWeight = '500';
                
                // ëª¨ë¸ ì •ë³´ ì—…ë°ì´íŠ¸
                updateModelInfo(selectedModel);
            }
        }
        
        // ëª¨ë¸ ì •ë³´ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
        function updateModelInfo(modelName) {
            const modelInfoEl = document.getElementById('model-info');
            const activityEl = document.getElementById('model-activity');
            
            if (!modelName) {
                modelInfoEl.textContent = 'ëª¨ë¸ ì„ íƒë˜ì§€ ì•ŠìŒ';
                activityEl.style.display = 'none';
                return;
            }
            
            // ëª¨ë¸ ìƒì„¸ ì •ë³´ ì¶”ì •
            const modelInfo = getModelInfo(modelName);
            modelInfoEl.innerHTML = `
                <div style="line-height: 1.3;">
                    <div style="font-weight: 600; color: #2c3e50; font-size: 0.9em;">
                        ${modelInfo.vendor} â€¢ ${modelInfo.size}
                    </div>
                    <div style="font-size: 0.75em; color: #6c757d;">
                        ${modelInfo.type} â€¢ ${modelInfo.language}
                    </div>
                </div>
            `;
            
            // ì‘ë™ ìƒíƒœ í‘œì‹œ
            activityEl.style.display = 'flex';
            updateModelActivity('idle');
        }
        
        // ëª¨ë¸ ì •ë³´ ì¶”ì • (ê°œì„ ëœ ë²„ì „)
        function getModelInfo(modelName) {
            const name = modelName.toLowerCase();
            
            // ì œì‘ì‚¬ ì¶”ì •
            let vendor = 'Unknown';
            if (name.includes('llama')) vendor = 'Meta';
            else if (name.includes('gemma')) vendor = 'Google';
            else if (name.includes('qwen')) vendor = 'Alibaba';
            else if (name.includes('mistral')) vendor = 'Mistral AI';
            else if (name.includes('phi')) vendor = 'Microsoft';
            else if (name.includes('codellama')) vendor = 'Meta';
            else if (name.includes('vicuna')) vendor = 'LMSYS';
            else if (name.includes('alpaca')) vendor = 'Stanford';
            else if (name.includes('wizardlm')) vendor = 'WizardLM';
            else if (name.includes('nous')) vendor = 'Nous Research';
            
            // í¬ê¸° ì¶”ì •
            let size = 'í¬ê¸° ë¶ˆëª…';
            if (name.includes('0.5b')) size = '0.5B';
            else if (name.includes('1b')) size = '1B';
            else if (name.includes('1.5b')) size = '1.5B';
            else if (name.includes('2b')) size = '2B';
            else if (name.includes('3b')) size = '3B';
            else if (name.includes('7b')) size = '7B';
            else if (name.includes('8b')) size = '8B';
            else if (name.includes('9b')) size = '9B';
            else if (name.includes('13b')) size = '13B';
            else if (name.includes('14b')) size = '14B';
            else if (name.includes('20b')) size = '20B';
            else if (name.includes('30b') || name.includes('33b')) size = '30B+';
            else if (name.includes('70b')) size = '70B';
            else if (name.includes('180b')) size = '180B';
            
            // íƒ€ì… ì¶”ì •
            let type = 'ì¼ë°˜í˜•';
            if (name.includes('instruct')) type = 'ì§€ì‹œ íŠ¹í™”';
            else if (name.includes('chat')) type = 'ëŒ€í™” íŠ¹í™”';
            else if (name.includes('code')) type = 'ì½”ë”© íŠ¹í™”';
            else if (name.includes('vision')) type = 'ë¹„ì „ ëª¨ë¸';
            else if (name.includes('math')) type = 'ìˆ˜í•™ íŠ¹í™”';
            else if (name.includes('reasoning')) type = 'ì¶”ë¡  íŠ¹í™”';
            
            // ì–¸ì–´ ì§€ì› ì¶”ì •
            let language = 'ë‹¤êµ­ì–´';
            if (name.includes('ko') || name.includes('korean')) language = 'í•œêµ­ì–´ íŠ¹í™”';
            else if (name.includes('en') || name.includes('english')) language = 'ì˜ì–´ íŠ¹í™”';
            else if (name.includes('zh') || name.includes('chinese')) language = 'ì¤‘êµ­ì–´ íŠ¹í™”';
            else if (name.includes('jp') || name.includes('japanese')) language = 'ì¼ë³¸ì–´ íŠ¹í™”';
            
            return { vendor, size, type, language };
        }
        
        // ëª¨ë¸ í™œë™ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateModelActivity(status, progress = 0) {
            const gauge = document.getElementById('activity-gauge');
            const text = document.getElementById('activity-text');
            
            if (!gauge || !text) return;
            
            switch(status) {
                case 'idle':
                    gauge.style.background = 'conic-gradient(#6c757d 0deg, #e9ecef 0deg)';
                    text.textContent = 'ëŒ€ê¸°ì¤‘';
                    text.style.color = '#6c757d';
                    break;
                case 'active':
                    const angle = (progress / 100) * 360;
                    gauge.style.background = `conic-gradient(#28a745 ${angle}deg, #e9ecef ${angle}deg)`;
                    text.textContent = 'í™œì„±';
                    text.style.color = '#28a745';
                    break;
                case 'processing':
                    gauge.style.background = 'conic-gradient(#007bff 0deg, #007bff 90deg, #e9ecef 90deg, #e9ecef 180deg, #007bff 180deg, #007bff 270deg, #e9ecef 270deg)';
                    gauge.style.animation = 'spin 1s linear infinite';
                    text.textContent = 'ì²˜ë¦¬ì¤‘';
                    text.style.color = '#007bff';
                    break;
                case 'error':
                    gauge.style.background = 'conic-gradient(#dc3545 0deg, #e9ecef 0deg)';
                    gauge.style.animation = 'none';
                    text.textContent = 'ì˜¤ë¥˜';
                    text.style.color = '#dc3545';
                    break;
            }
        }
        
        // ì‹œìŠ¤í…œ í†µê³„ ì—…ë°ì´íŠ¸
        async function updateSystemStats() {
            try {
                // ë¬¸ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const docsRes = await fetch('/api/documents');
                const docsData = await docsRes.json();
                
                // ì €ì¥ì†Œ í†µê³„ ê°€ì ¸ì˜¤ê¸°
                const statsRes = await fetch('/api/storage/stats');
                const statsData = await statsRes.json();
                
                // UI ì—…ë°ì´íŠ¸
                const docCount = docsData.documents ? docsData.documents.length : 0;
                const totalChunks = docsData.documents ? 
                    docsData.documents.reduce((sum, doc) => sum + (doc.chunk_count || 0), 0) : 0;
                
                document.getElementById('doc-count').textContent = docCount;
                document.getElementById('chunk-count').textContent = totalChunks;
                
                if (statsRes.ok && statsData.file_storage) {
                    const sizeMB = Math.round(statsData.file_storage.total_size_mb || 0);
                    document.getElementById('storage-size').textContent = `${sizeMB}MB`;
                }
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-update').textContent = timeStr;
                
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }
        
        // ë¹ ë¥¸ ì„¤ì • í† ê¸€ ì´ë²¤íŠ¸
        function setupQuickSettings() {
            // OCR êµì • í† ê¸€
            const ocrToggle = document.getElementById('ocr-correction-toggle');
            ocrToggle.addEventListener('change', (e) => {
                console.log('OCR êµì •:', e.target.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');
                // ì‹¤ì œ ì„¤ì • ë³€ê²½ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
            });
            
            // LLM êµì • í† ê¸€
            const llmToggle = document.getElementById('llm-correction-toggle');
            llmToggle.addEventListener('change', (e) => {
                console.log('LLM êµì •:', e.target.checked ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');
                // ì‹¤ì œ ì„¤ì • ë³€ê²½ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
            });
            
            // ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            autoRefreshToggle.addEventListener('change', (e) => {
                if (e.target.checked) {
                    startDocumentListPolling();
                    updateAutoRefreshIndicator('í™œì„±í™”');
                } else {
                    stopDocumentListPolling();
                    updateAutoRefreshIndicator('ë¹„í™œì„±í™”');
                }
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ Ollama ìƒíƒœ/ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” ì•„ë˜ DOMContentLoadedì—ì„œ ì²˜ë¦¬

        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ë‹¨ê³„ë³„ ë§¤í•‘
        const progressSteps = [
            { step: 'OCR', percent: 20 },
            { step: 'Chunking', percent: 40 },
            { step: 'Embedding', percent: 60 },
            { step: 'Storing', percent: 80 },
            { step: 'Done', percent: 100 },
            { step: 'Error', percent: 100 },
        ];
        
        // ë‹¤ì¤‘ íŒŒì¼ ì§„í–‰ë¥  ì¶”ì  ë³€ìˆ˜ë“¤
        let multiFileTracking = {
            files: new Map(), // documentId -> {filename, status, interval, startTime}
            intervals: new Set(),
            hideTimeout: null
        };
        
        // ê²½ê³¼ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
        function formatElapsedTime(startTime) {
            if (!startTime) return '';
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // ë‹¤ì¤‘ íŒŒì¼ ì§„í–‰ë¥  ì¶”ì  ì‹œì‘
        function startMultiFileProgressTracking(files) {
            console.log('ë‹¤ì¤‘ íŒŒì¼ ì§„í–‰ë¥  ì¶”ì  ì‹œì‘:', files);
            
            // ì§„í–‰ë¥  ì»¨í…Œì´ë„ˆ í‘œì‹œ
            const progressContainer = document.getElementById('progress-container');
            progressContainer.style.display = 'block';
            
            // ê¸°ì¡´ ë°ì´í„° ì •ë¦¬
            clearMultiFileTracking();
            
            // ì „ì²´ ì§„í–‰ë¥  ì´ˆê¸°í™”
            updateOverallProgress(0, files.length);
            
            // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  UI ìƒì„± ë° ì¶”ì  ì‹œì‘
            files.forEach(file => {
                createIndividualProgressUI(file.documentId, file.filename);
                startIndividualFileTracking(file.documentId, file.filename);
            });
        }
        
        // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  UI ìƒì„± (ë™ì  ìŠ¤íƒ€ì¼)
        function createIndividualProgressUI(documentId, filename) {
            const container = document.getElementById('individual-progress-container');
            
            const fileDiv = document.createElement('div');
            fileDiv.id = `progress-${documentId}`;
            fileDiv.className = 'file-progress-card';
            fileDiv.style.cssText = `
                margin-bottom: 15px; 
                padding: 15px; 
                border: 1px solid #dee2e6; 
                border-radius: 12px; 
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
            `;
            
            fileDiv.innerHTML = `
                <!-- íŒŒì¼ í—¤ë” -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div id="file-icon-${documentId}" style="font-size: 1.2em;">ğŸ“„</div>
                        <span style="font-weight: 600; color: #2c3e50; font-size: 1rem;">ë¬¸ì„œ ì²˜ë¦¬ ì¤‘...</span>
                    </div>
                    <div id="status-badge-${documentId}" class="status-badge status-waiting">
                        <span id="status-text-${documentId}">ëŒ€ê¸° ì¤‘</span>
                    </div>
                </div>
                
                <!-- ì²˜ë¦¬ ë‹¨ê³„ í‘œì‹œ (ë™ì ) -->
                <div id="process-steps-${documentId}" class="process-steps-dynamic">
                    <!-- í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë‹¨ê³„ë§Œ í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <!-- ì§„í–‰ë¥  ë°” (ì „ì²´) -->
                <div style="margin-top: 10px;">
                    <div style="height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar-${documentId}" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #6c757d;">
                        <span id="progress-text-${documentId}">0%</span>
                        <span id="time-info-${documentId}"></span>
                    </div>
                </div>
            `;
            
            container.appendChild(fileDiv);
        }
        
        // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  ì¶”ì 
        function startIndividualFileTracking(documentId, filename) {
            const startTime = Date.now(); // ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
            
            const interval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/upload_status/${documentId}`);
                    const data = await res.json();
                    
                    updateIndividualProgress(documentId, data);
                    
                    // íŒŒì¼ ìƒíƒœ ì—…ë°ì´íŠ¸ - ë°±ì—”ë“œ percent ê°’ ìš°ì„  ì‚¬ìš©
                    const actualPercent = data.percent !== undefined ? data.percent : (progressSteps.find(s => s.step === data.step) || { percent: 0 }).percent;
                    const fileInfo = multiFileTracking.files.get(documentId) || {};
                    multiFileTracking.files.set(documentId, {
                        ...fileInfo,
                        filename,
                        status: data.step,
                        progress: actualPercent,
                        completed: data.step === 'Done' || data.step === 'Error',
                        startTime: fileInfo.startTime || startTime // ì‹œì‘ ì‹œê°„ ìœ ì§€
                    });
                    
                    // ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
                    updateOverallProgressFromFiles();
                    
                    if (data.step === 'Done' || data.step === 'Error') {
                        clearInterval(interval);
                        multiFileTracking.intervals.delete(interval);
                        checkAllFilesCompleted();
                    }
                } catch (error) {
                    console.error(`ì§„í–‰ë¥  ì¶”ì  ì˜¤ë¥˜ (${documentId}):`, error);
                    document.getElementById(`message-${documentId}`).textContent = 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
                }
            }, 1500);
            
            multiFileTracking.intervals.add(interval);
            multiFileTracking.files.set(documentId, {
                filename,
                status: 'processing',
                interval,
                completed: false,
                startTime: startTime // ì‹œì‘ ì‹œê°„ ì €ì¥
            });
        }
        
        // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ë™ì  ìŠ¤íƒ€ì¼)
        function updateIndividualProgress(documentId, data) {
            // ë°±ì—”ë“œ percent ê°’ì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ë‹¨ê³„ë³„ ê°’ ì‚¬ìš©
            const percent = data.percent !== undefined ? data.percent : (progressSteps.find(s => s.step === data.step) || { percent: 0 }).percent;
            
            // ë©”ì¸ UI ìš”ì†Œë“¤
            const fileCard = document.getElementById(`progress-${documentId}`);
            const progressBar = document.getElementById(`progress-bar-${documentId}`);
            const statusBadge = document.getElementById(`status-badge-${documentId}`);
            const statusText = document.getElementById(`status-text-${documentId}`);
            const progressText = document.getElementById(`progress-text-${documentId}`);
            const timeInfo = document.getElementById(`time-info-${documentId}`);
            const fileIcon = document.getElementById(`file-icon-${documentId}`);
            
            // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ (ì‹¤ì œ percent ê°’ ì‚¬ìš©, 0-100 ë²”ìœ„ ì œí•œ)
            const displayPercent = Math.max(0, Math.min(100, Math.round(percent)));
            if (progressBar) progressBar.style.width = displayPercent + '%';
            if (progressText) {
                // í˜ì´ì§€ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€ í‘œì‹œ
                if (data.current_page && data.total_pages) {
                    progressText.textContent = `${displayPercent}% (${data.current_page}/${data.total_pages} í˜ì´ì§€)`;
                } else {
                    progressText.textContent = `${displayPercent}%`;
                }
            }
            
            // multiFileTrackingì˜ íŒŒì¼ ì •ë³´ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            if (multiFileTracking.files.has(documentId)) {
                const fileInfo = multiFileTracking.files.get(documentId);
                fileInfo.progress = displayPercent;
                fileInfo.status = data.step;
                fileInfo.completed = data.step === 'Done' || data.step === 'Error';
                multiFileTracking.files.set(documentId, fileInfo);
            }
            
            // í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ ì—…ë°ì´íŠ¸ (ìƒì„¸ ì •ë³´ í¬í•¨)
            updateProcessSteps(documentId, data.step, data);
            
            if (data.step === 'Done') {
                // ì™„ë£Œ ìƒíƒœ
                if (fileCard) {
                    fileCard.className = 'file-progress-card completed';
                }
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-completed';
                }
                if (statusText) statusText.textContent = 'ì™„ë£Œ';
                if (fileIcon) fileIcon.textContent = 'âœ…';
                if (progressBar) {
                    progressBar.style.background = 'linear-gradient(90deg, #28a745 0%, #20c997 100%)';
                    progressBar.style.width = '100%';
                }
                if (progressText) progressText.textContent = '100%';
                if (timeInfo) timeInfo.textContent = 'ì™„ë£Œë¨';
                
            } else if (data.step === 'Error') {
                // ì˜¤ë¥˜ ìƒíƒœ
                if (fileCard) {
                    fileCard.className = 'file-progress-card error';
                }
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-error';
                }
                if (statusText) statusText.textContent = 'ì˜¤ë¥˜';
                if (fileIcon) fileIcon.textContent = 'âŒ';
                if (progressBar) {
                    progressBar.style.background = 'linear-gradient(90deg, #dc3545 0%, #e74c3c 100%)';
                }
                if (timeInfo) timeInfo.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                
            } else {
                // ì²˜ë¦¬ ì¤‘ ìƒíƒœ
                if (fileCard) {
                    fileCard.className = 'file-progress-card processing';
                }
                if (statusBadge) {
                    statusBadge.className = 'status-badge status-processing';
                }
                if (statusText) statusText.textContent = 'ì²˜ë¦¬ ì¤‘';
                if (fileIcon) fileIcon.textContent = 'âš™ï¸';
                if (timeInfo) {
                    const fileInfo = multiFileTracking.files.get(documentId);
                    if (fileInfo && fileInfo.startTime) {
                        timeInfo.textContent = formatElapsedTime(fileInfo.startTime);
                    } else {
                        timeInfo.textContent = '00:00';
                    }
                }
            }
        }
        
        // í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ ì‹œê°í™” ì—…ë°ì´íŠ¸ (ë™ì  ë°©ì‹)
        function updateProcessSteps(documentId, currentStep, data = {}) {
            const processStepsContainer = document.getElementById(`process-steps-${documentId}`);
            if (!processStepsContainer) return;
            
            // ìƒì„¸í•œ ë‹¨ê³„ë³„ í‘œì‹œ ì •ë³´
            let stepText = '';
            let stepIcon = '';
            
            switch(currentStep) {
                case 'Analyzing':
                    stepIcon = 'ğŸ”';
                    stepText = `PDF íŒŒì¼ ë¶„ì„ ì¤‘... ${data.total_pages ? `(${data.total_pages}í˜ì´ì§€)` : ''}`;
                    break;
                case 'OCR':
                    stepIcon = 'ğŸ‘ï¸';
                    if (data.current_page && data.total_pages) {
                        const details = data.details || {};
                        const stage = details.stage || '';
                        let stageText = '';
                        if (stage === 'text') stageText = 'í…ìŠ¤íŠ¸ ì¶”ì¶œ';
                        else if (stage === 'images') stageText = 'ì´ë¯¸ì§€ ì¶”ì¶œ';
                        else if (stage === 'tables') stageText = 'í‘œ ì¶”ì¶œ';
                        
                        stepText = `${stageText} ì¤‘... (${data.current_page}/${data.total_pages} í˜ì´ì§€)`;
                    } else if (data.message) {
                        stepText = data.message;
                    } else {
                        stepText = 'OCR ì²˜ë¦¬ ì¤‘...';
                    }
                    break;
                case 'Chunking':
                    stepIcon = 'ğŸ“';
                    if (data.details && data.details.text_length) {
                        stepText = `í…ìŠ¤íŠ¸ ë¶„í•  ì¤‘... (${data.details.text_length.toLocaleString()}ì)`;
                    } else if (data.message) {
                        stepText = data.message;
                    } else {
                        stepText = 'í…ìŠ¤íŠ¸ ì²­í¬ ë¶„í•  ì¤‘...';
                    }
                    break;
                case 'Embedding':
                    stepIcon = 'ğŸ§ ';
                    if (data.details && data.details.chunks_to_process) {
                        stepText = `ì„ë² ë”© ìƒì„± ì¤‘... (${data.details.chunks_to_process}ê°œ ì²­í¬)`;
                    } else if (data.message) {
                        stepText = data.message;
                    } else {
                        stepText = 'ë²¡í„° ì„ë² ë”© ìƒì„± ì¤‘...';
                    }
                    break;
                case 'Storing':
                    stepIcon = 'ğŸ’¾';
                    if (data.details) {
                        const details = data.details;
                        const parts = [];
                        if (details.texts) parts.push(`í…ìŠ¤íŠ¸ ${details.texts}ê°œ`);
                        if (details.images) parts.push(`ì´ë¯¸ì§€ ${details.images}ê°œ`);
                        if (details.tables) parts.push(`í‘œ ${details.tables}ê°œ`);
                        stepText = `ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘... (${parts.join(', ')})`;
                    } else if (data.message) {
                        stepText = data.message;
                    } else {
                        stepText = 'ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ ì¤‘...';
                    }
                    break;
                case 'Done':
                    stepIcon = 'âœ…';
                    if (data.details) {
                        const details = data.details;
                        stepText = `ì²˜ë¦¬ ì™„ë£Œ! (${details.total_pages || 0}í˜ì´ì§€, ${details.text_chunks || 0}ì²­í¬, ${details.images || 0}ì´ë¯¸ì§€, ${details.tables || 0}í‘œ)`;
                    } else if (data.message) {
                        stepText = data.message;
                    } else {
                        stepText = 'ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                    }
                    break;
                case 'Error':
                    stepIcon = 'âŒ';
                    stepText = data.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    break;
                default:
                    stepIcon = 'â³';
                    stepText = data.message || 'ì¤€ë¹„ ì¤‘...';
            }
            
            // ìƒíƒœë³„ CSS í´ë˜ìŠ¤ ê²°ì •
            let statusClass = 'waiting';
            if (currentStep === 'Done') {
                statusClass = 'completed';
            } else if (currentStep === 'Error') {
                statusClass = 'error';
            } else if (['Analyzing', 'OCR', 'Chunking', 'Embedding', 'Storing'].includes(currentStep)) {
                statusClass = 'processing';
            }
            
            // ê²½ê³¼ì‹œê°„ ì¶”ê°€ (ì˜µì…˜)
            const fileInfo = multiFileTracking.files.get(documentId);
            const elapsedTime = (fileInfo && fileInfo.startTime) ? formatElapsedTime(fileInfo.startTime) : '';
            
            // ë™ì ìœ¼ë¡œ í˜„ì¬ ë‹¨ê³„ í‘œì‹œ (ë” ìƒì„¸í•œ ì •ë³´ í¬í•¨)
            processStepsContainer.innerHTML = `
                <div class="current-step-display ${statusClass}">
                    <div class="step-header">
                        <div class="step-icon ${statusClass}">${stepIcon}</div>
                        <div class="step-text">
                            <div class="main-text">${stepText}</div>
                            ${elapsedTime ? `<div class="elapsed-time">${elapsedTime}</div>` : ''}
                        </div>
                    </div>
                    ${data.details && Object.keys(data.details).length > 0 ? 
                        `<div class="step-details">
                            ${getFormattedDetails(data.details)}
                        </div>` : ''
                    }
                </div>
            `;
        }
        
        // ìƒì„¸ ì •ë³´ë¥¼ í¬ë§·íŒ…í•˜ì—¬ í‘œì‹œ
        function getFormattedDetails(details) {
            const items = [];
            
            if (details.stage) {
                const stageNames = {
                    'text': 'í…ìŠ¤íŠ¸ ì¶”ì¶œ',
                    'images': 'ì´ë¯¸ì§€ ì¶”ì¶œ', 
                    'tables': 'í‘œ ì¶”ì¶œ'
                };
                items.push(`ì²˜ë¦¬ ë‹¨ê³„: ${stageNames[details.stage] || details.stage}`);
            }
            
            if (details.pages_processed !== undefined) {
                items.push(`ì²˜ë¦¬ëœ í˜ì´ì§€: ${details.pages_processed}ê°œ`);
            }
            
            if (details.text_length !== undefined) {
                items.push(`í…ìŠ¤íŠ¸ ê¸¸ì´: ${details.text_length.toLocaleString()}ì`);
            }
            
            if (details.chunks_created !== undefined) {
                items.push(`ìƒì„±ëœ ì²­í¬: ${details.chunks_created}ê°œ`);
            }
            
            if (details.embeddings_created !== undefined) {
                items.push(`ìƒì„±ëœ ì„ë² ë”©: ${details.embeddings_created}ê°œ`);
            }
            
            if (details.embedding_dimension !== undefined) {
                items.push(`ë²¡í„° ì°¨ì›: ${details.embedding_dimension}ì°¨ì›`);
            }
            
            return items.map(item => `<div class="detail-item">â€¢ ${item}</div>`).join('');
        }
        
        // ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ ìƒì„±
        function getFriendlyMessage(step, originalMessage) {
            const friendlyMessages = {
                'OCR': 'ğŸ‘ï¸ OCRë¡œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                'Chunking': 'ğŸ“ í…ìŠ¤íŠ¸ë¥¼ ì²­í¬ë¡œ ë¶„í• í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                'Embedding': 'ğŸ§  ì„ë² ë”© ë²¡í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                'Storing': 'ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                'Done': 'âœ… ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
            };
            
            return friendlyMessages[step] || originalMessage || 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
        }
        
        // ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì™„ë£Œ ê°œìˆ˜ ê¸°ë°˜)
        function updateOverallProgress(completedCount, totalCount) {
            const progressBar = document.getElementById('overall-progress-bar');
            const countSpan = document.getElementById('overall-progress-count');
            const textSpan = document.getElementById('overall-progress-text');
            
            const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            
            if (progressBar) progressBar.style.width = percentage + '%';
            if (countSpan) countSpan.textContent = `${completedCount}/${totalCount} ì™„ë£Œ`;
            if (textSpan) {
                if (completedCount === totalCount && totalCount > 0) {
                    textSpan.textContent = 'âœ… ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ';
                    progressBar.style.background = '#28a745';
                } else {
                    textSpan.textContent = 'ì „ì²´ ì§„í–‰ë¥ ';
                    progressBar.style.background = '#28a745';
                }
            }
        }
        
        // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥  ê¸°ë°˜ ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
        function updateOverallProgressFromFiles() {
            const progressBar = document.getElementById('overall-progress-bar');
            const countSpan = document.getElementById('overall-progress-count');
            const textSpan = document.getElementById('overall-progress-text');
            
            const files = Array.from(multiFileTracking.files.values());
            if (files.length === 0) return;
            
            // ê°œë³„ íŒŒì¼ ì§„í–‰ë¥ ì˜ ê°€ì¤‘ í‰ê·  ê³„ì‚° (ì‹¤ì œ ì§„í–‰ë¥  ë°˜ì˜)
            const totalProgress = files.reduce((sum, file) => {
                // progress ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³  0-100 ë²”ìœ„ë¡œ ì œí•œ
                const fileProgress = Math.max(0, Math.min(100, file.progress || 0));
                return sum + fileProgress;
            }, 0);
            const averageProgress = Math.round(totalProgress / files.length);
            
            // ì™„ë£Œëœ íŒŒì¼ ê°œìˆ˜
            const completedFiles = files.filter(f => f.completed);
            const completedCount = completedFiles.length;
            const totalCount = files.length;
            
            // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸ (í‰ê·  ì§„í–‰ë¥  ê¸°ë°˜, ì™„ë£Œ ìƒíƒœ ê³ ë ¤)
            let displayProgress = averageProgress;
            
            // ëª¨ë“  íŒŒì¼ì´ ì™„ë£Œë˜ë©´ 100%ë¡œ ì„¤ì •
            if (completedCount === totalCount && totalCount > 0) {
                displayProgress = 100;
            }
            
            if (progressBar) progressBar.style.width = displayProgress + '%';
            if (countSpan) countSpan.textContent = `${completedCount}/${totalCount} ì™„ë£Œ`;
            if (textSpan) {
                if (completedCount === totalCount && totalCount > 0) {
                    textSpan.textContent = 'âœ… ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ';
                    if (progressBar) progressBar.style.background = '#28a745';
                } else {
                    textSpan.textContent = `ì „ì²´ ì§„í–‰ë¥  (${displayProgress}%)`;
                    if (progressBar) progressBar.style.background = '#007bff';
                }
            }
            
            // ë””ë²„ê¹… ë¡œê·¸ (ê°œë°œ ì‹œì—ë§Œ ì‚¬ìš©)
            console.log(`ì „ì²´ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸: ${displayProgress}% (ì™„ë£Œ: ${completedCount}/${totalCount})`);
        }
        
        // ëª¨ë“  íŒŒì¼ ì™„ë£Œ í™•ì¸
        function checkAllFilesCompleted() {
            const files = Array.from(multiFileTracking.files.values());
            const completedFiles = files.filter(f => f.completed);
            const totalFiles = files.length;
            
            updateOverallProgress(completedFiles.length, totalFiles);
            
            if (completedFiles.length === totalFiles && totalFiles > 0) {
                console.log('ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ!');
                
                // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    fetchDocumentList();
                    console.log('ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ: ë¬¸ì„œ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨');
                }, 1000);
                
                // ìë™ ìˆ¨ê¹€ ì„¤ì • í™•ì¸
                const autoHide = document.getElementById('auto-hide-progress');
                if (autoHide && autoHide.checked) {
                    scheduleProgressHide();
                }
            }
        }
        
        // ì§„í–‰ë¥  ì°½ ìë™ ìˆ¨ê¹€ ì˜ˆì•½
        function scheduleProgressHide() {
            if (multiFileTracking.hideTimeout) {
                clearTimeout(multiFileTracking.hideTimeout);
            }
            
            multiFileTracking.hideTimeout = setTimeout(() => {
                const progressContainer = document.getElementById('progress-container');
                const selectedFilesContainer = document.getElementById('selected-files-container');
                
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                    clearMultiFileTracking();
                }
                
                // ì„ íƒëœ íŒŒì¼ ëª©ë¡ë„ ìˆ¨ê¸°ê³  ì´ˆê¸°í™”
                if (selectedFilesContainer) {
                    selectedFilesContainer.style.display = 'none';
                    document.getElementById('selected-files-list').innerHTML = '';
                    selectedFilesForUpload.clear();
                    
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    const pdfFileInput = document.getElementById('pdf-file');
                    if (pdfFileInput) {
                        pdfFileInput.value = '';
                    }
                    
                    // ì—…ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                    updateSelectedCount();
                }
            }, 10000); // 10ì´ˆ í›„ ìˆ¨ê¹€
        }
        
        // ë‹¤ì¤‘ íŒŒì¼ ì¶”ì  ì •ë¦¬
        function clearMultiFileTracking() {
            // ëª¨ë“  ì¸í„°ë²Œ ì •ë¦¬
            multiFileTracking.intervals.forEach(interval => clearInterval(interval));
            multiFileTracking.intervals.clear();
            
            // ìˆ¨ê¹€ íƒ€ì´ë¨¸ ì •ë¦¬
            if (multiFileTracking.hideTimeout) {
                clearTimeout(multiFileTracking.hideTimeout);
                multiFileTracking.hideTimeout = null;
            }
            
            // íŒŒì¼ ë°ì´í„° ì •ë¦¬
            multiFileTracking.files.clear();
            
            // ê°œë³„ ì§„í–‰ë¥  UI ì •ë¦¬
            const container = document.getElementById('individual-progress-container');
            if (container) container.innerHTML = '';
        }
        
        // ê¸°ì¡´ ë‹¨ì¼ íŒŒì¼ ì§„í–‰ë¥  í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
        function startProgressPolling(documentId) {
            const progressContainer = document.getElementById('progress-container');
            const progressBarInner = document.getElementById('progress-bar-inner');
            const progressMessage = document.getElementById('progress-message');
            progressContainer.style.display = 'block';
            progressBarInner.style.width = '0%';
            progressMessage.textContent = 'ì²˜ë¦¬ ëŒ€ê¸° ì¤‘...';
            if(progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/upload_status/${documentId}`);
                    const data = await res.json();
                    const stepInfo = progressSteps.find(s => s.step === data.step) || { percent: 0 };
                    progressBarInner.style.width = stepInfo.percent + '%';
                    progressMessage.textContent = data.message || '';
                    if(data.step === 'Done') {
                        progressMessage.textContent = 'âœ… ' + data.message;
                        clearInterval(progressInterval);
                        // ì²˜ë¦¬ ì™„ë£Œ ì‹œ ë¬¸ì„œ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            fetchDocumentList();
                            console.log('ë¬¸ì„œ ì²˜ë¦¬ ì™„ë£Œ: ë¬¸ì„œ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨');
                        }, 1000);
                    } else if(data.step === 'Error') {
                        progressMessage.textContent = 'âŒ ' + data.message;
                        progressBarInner.style.background = '#dc3545';
                        clearInterval(progressInterval);
                    }
                } catch (e) {
                    progressMessage.textContent = 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
                }
            }, 1500);
        }

        // ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        async function fetchDocumentList() {
            try {
                const res = await fetch('/api/documents');
                const data = await res.json();
                
                // ì±„íŒ…ìš© ë¬¸ì„œ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                const info = document.getElementById('document-info');
                const selectAllCheckbox = document.getElementById('select-all-docs');
                const container = document.getElementById('individual-doc-checkboxes');
                const documentList = document.getElementById('document-list');
                
                if (!container || !documentList) {
                    console.error('Required DOM elements not found');
                    return;
                }
                
                container.innerHTML = '';
                documentList.innerHTML = '';
                
                // ê¸°ë³¸ ì „ì²´ ë¬¸ì„œ ì„ íƒ
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                }
                
                // ê°œë³„ ë¬¸ì„œ ì²´í¬ë°•ìŠ¤ ìƒì„±
                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(doc => {
                        // ì±„íŒ…ìš© ì²´í¬ë°•ìŠ¤
                        const div = document.createElement('div');
                        div.style.marginBottom = '4px';
                        div.innerHTML = `
                            <input type="checkbox" id="doc-checkbox-${doc.document_id}" value="${doc.document_id}" data-preview="${doc.first_chunk_preview || ''}" disabled>
                            <label for="doc-checkbox-${doc.document_id}">${doc.document_id} (${doc.chunk_count}ì²­í¬)</label>
                        `;
                        container.appendChild(div);
                        
                        // ë¬¸ì„œ ê´€ë¦¬ ëª©ë¡
                        const docDiv = document.createElement('div');
                        docDiv.className = 'document-item';
                        docDiv.innerHTML = `
                            <div class="document-info">
                                <div class="document-title">ğŸ“„ ${doc.document_id}</div>
                                <div class="text-muted">${doc.chunk_count} ì²­í¬</div>
                                <div class="document-preview">
                                    ${doc.first_chunk_preview ? doc.first_chunk_preview.slice(0, 100) + '...' : 'ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ'}
                                </div>
                            </div>
                            <div class="document-actions">
                                <button onclick="deleteDocument('${doc.document_id}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9rem;">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        `;
                        documentList.appendChild(docDiv);
                    });
                    
                    // ì²« ë¬¸ì„œ ì •ë³´ í‘œì‹œ
                    if (info) {
                        info.textContent = data.documents[0].first_chunk_preview ? 
                            `ë¯¸ë¦¬ë³´ê¸°: ${data.documents[0].first_chunk_preview.slice(0, 60)}...` : '';
                    }
                    
                    // í´ë§ìš© ë¬¸ì„œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                    lastDocumentCount = data.documents.length;
                } else {
                    if (info) info.textContent = '';
                    documentList.innerHTML = '<div class="text-center text-muted">ğŸ“­ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    lastDocumentCount = 0;
                }
                
                // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', () => {
                        const checked = selectAllCheckbox.checked;
                        const boxes = container.querySelectorAll('input[type="checkbox"]');
                        boxes.forEach(cb => { 
                            cb.disabled = checked; 
                            if (checked) cb.checked = false; 
                        });
                        updateChatPreview();
                    });
                }
                
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', updateChatPreview);
                });
                
            } catch (e) {
                console.error('ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
                const documentList = document.getElementById('document-list');
                if (documentList) {
                    documentList.innerHTML = '<div class="status-message status-error">âŒ ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
                }
                if (document.getElementById('document-info')) {
                    document.getElementById('document-info').textContent = '';
                }
            }
        }
        // ì±—ë´‡ìš© ë¬¸ì„œ ì„ íƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateChatPreview() {
            const info = document.getElementById('document-info');
            const selectAll = document.getElementById('select-all-docs').checked;
            if (selectAll) {
                info.textContent = '';
                return;
            }
            const checked = Array.from(
                document.querySelectorAll('#individual-doc-checkboxes input[type="checkbox"]:checked')
            );
            const previews = checked.map(cb => cb.getAttribute('data-preview')).filter(Boolean);
            info.textContent = previews.length > 0
                ? `ë¯¸ë¦¬ë³´ê¸°: ${previews.map(p => p.slice(0, 60)).join(' | ')}...`
                : '';
        }
        // ì„ íƒëœ ë¬¸ì„œ ID ë°°ì—´ ë°˜í™˜ (ë¹ˆ ë°°ì—´ì€ ì „ì²´ ë¬¸ì„œ ì˜ë¯¸)
        function getSelectedDocumentIds() {
            const selectAll = document.getElementById('select-all-docs').checked;
            if (selectAll) return [];
            const checked = document.querySelectorAll('#individual-doc-checkboxes input[type="checkbox"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        // ë¬¸ì„œ ê´€ë¦¬ ê¸°ëŠ¥ë“¤
        async function deleteDocument(documentId) {
            if (!confirm(`ë¬¸ì„œ "${documentId}"ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            // ê¸°ì¡´ ë©”ì‹œì§€ í´ë¦¬ì–´
            clearManagementStatus();
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âœ… ë¬¸ì„œ "${documentId}" ì‚­ì œ ì™„ë£Œ`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    
                    // ì„±ê³µ ë©”ì‹œì§€ë¥¼ 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
                    setTimeout(() => {
                        clearManagementStatus();
                    }, 3000);
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        // ë©”ì‹œì§€ í´ë¦¬ì–´ í—¬í¼ í•¨ìˆ˜
        function clearManagementStatus() {
            const statusEl = document.getElementById('management-status');
            statusEl.textContent = '';
            statusEl.className = 'status-message';
        }

        async function deleteAllDocuments() {
            if (!confirm('ëª¨ë“  ë¬¸ì„œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            // ê¸°ì¡´ ë©”ì‹œì§€ í´ë¦¬ì–´
            clearManagementStatus();
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = 
                        `âœ… ëª¨ë“  ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ (ë¬¸ì„œ: ${result.deleted_documents_count}ê°œ, íŒŒì¼: ${result.deleted_files_count}ê°œ)`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    
                    // ì„±ê³µ ë©”ì‹œì§€ë¥¼ 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
                    setTimeout(() => {
                        clearManagementStatus();
                    }, 5000);
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        async function showStorageStats() {
            try {
                const response = await fetch('/api/storage/stats');
                const result = await response.json();
                
                if (response.ok) {
                    const stats = `ğŸ“Š ì €ì¥ì†Œ í†µê³„:\n` +
                        `íŒŒì¼: ${result.file_storage.total_files}ê°œ (${result.file_storage.total_size_mb}MB)\n` +
                        `ë¬¸ì„œ: ${result.vector_db.total_documents}ê°œ\n` +
                        `ì²­í¬: ${result.vector_db.total_chunks}ê°œ`;
                    alert(stats);
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        async function cleanupOrphanedFiles() {
            if (!confirm('ê³ ì•„ íŒŒì¼ë“¤ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            // ê¸°ì¡´ ë©”ì‹œì§€ í´ë¦¬ì–´
            clearManagementStatus();
            
            try {
                const response = await fetch('/api/documents/cleanup', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = 
                        `âœ… ì •ë¦¬ ì™„ë£Œ: ${result.cleaned_files_count}ê°œ íŒŒì¼ ì •ë¦¬ë¨`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    
                    // ì„±ê³µ ë©”ì‹œì§€ë¥¼ 4ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
                    setTimeout(() => {
                        clearManagementStatus();
                    }, 4000);
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì •ë¦¬ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        // ë¬¸ì„œ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (30ì´ˆ)
        let documentListInterval = null;
        let lastDocumentCount = 0;
        
        function startDocumentListPolling() {
            // ê¸°ì¡´ ì¸í„°ë²Œ ì •ë¦¬
            if (documentListInterval) {
                clearInterval(documentListInterval);
            }
            
            // 30ì´ˆë§ˆë‹¤ ë¬¸ì„œ ëª©ë¡ í™•ì¸
            documentListInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/documents');
                    const data = await res.json();
                    const currentDocumentCount = data.documents ? data.documents.length : 0;
                    
                    // ë¬¸ì„œ ê°œìˆ˜ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    if (currentDocumentCount !== lastDocumentCount) {
                        console.log(`ë¬¸ì„œ ê°œìˆ˜ ë³€ê²½ ê°ì§€: ${lastDocumentCount} â†’ ${currentDocumentCount}`);
                        fetchDocumentList();
                        lastDocumentCount = currentDocumentCount;
                        
                        // ìë™ ìƒˆë¡œê³ ì¹¨ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
                        updateAutoRefreshIndicator('ë³€ê²½ ê°ì§€ë¨');
                    }
                } catch (error) {
                    console.log('ë¬¸ì„œ ëª©ë¡ í´ë§ ì˜¤ë¥˜:', error);
                }
            }, 30000); // 30ì´ˆ ê°„ê²©
        }
        
        function stopDocumentListPolling() {
            if (documentListInterval) {
                clearInterval(documentListInterval);
                documentListInterval = null;
            }
        }
        
        function updateAutoRefreshIndicator(status) {
            const indicator = document.getElementById('auto-refresh-indicator');
            if (!indicator) return;
            
            const timestamp = new Date().toLocaleTimeString();
            
            switch(status) {
                case 'ë³€ê²½ ê°ì§€ë¨':
                    indicator.innerHTML = `ğŸ”„ ëª©ë¡ ì—…ë°ì´íŠ¸ë¨ (${timestamp})`;
                    indicator.style.color = '#28a745';
                    setTimeout(() => {
                        indicator.innerHTML = 'ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±í™”';
                        indicator.style.color = '#28a745';
                    }, 3000);
                    break;
                case 'í™œì„±í™”':
                    indicator.innerHTML = 'ğŸ”„ ìë™ ìƒˆë¡œê³ ì¹¨ í™œì„±í™”';
                    indicator.style.color = '#28a745';
                    break;
                case 'ë¹„í™œì„±í™”':
                    indicator.innerHTML = 'â¸ï¸ ìë™ ìƒˆë¡œê³ ì¹¨ ë¹„í™œì„±í™”';
                    indicator.style.color = '#6c757d';
                    break;
                default:
                    indicator.innerHTML = `ğŸ”„ ${status}`;
                    indicator.style.color = '#17a2b8';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            fetchOllamaStatusAndModels();
            fetchDocumentList();
            updateSystemStats(); // ìƒˆë¡œ ì¶”ê°€: ì‹œìŠ¤í…œ í†µê³„ ì´ˆê¸°í™”
            setupQuickSettings(); // ìƒˆë¡œ ì¶”ê°€: ë¹ ë¥¸ ì„¤ì • í† ê¸€ ì´ˆê¸°í™”
            
            // ë¬¸ì„œ ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘
            startDocumentListPolling();
            updateAutoRefreshIndicator('í™œì„±í™”');
            
            // ë¬¸ì„œ ê´€ë¦¬ ë²„íŠ¼ë“¤
            document.getElementById('refresh-documents').addEventListener('click', fetchDocumentList);
            document.getElementById('storage-stats').addEventListener('click', showStorageStats);
            document.getElementById('cleanup-files').addEventListener('click', cleanupOrphanedFiles);
            document.getElementById('delete-all-documents').addEventListener('click', deleteAllDocuments);
            
            // ì§„í–‰ë¥  ì°½ ë‹«ê¸° ë²„íŠ¼
            document.getElementById('hide-progress').addEventListener('click', () => {
                const progressContainer = document.getElementById('progress-container');
                const selectedFilesContainer = document.getElementById('selected-files-container');
                
                progressContainer.style.display = 'none';
                clearMultiFileTracking();
                
                // ì„ íƒëœ íŒŒì¼ ëª©ë¡ë„ ìˆ¨ê¸°ê³  ì´ˆê¸°í™”
                if (selectedFilesContainer) {
                    selectedFilesContainer.style.display = 'none';
                    document.getElementById('selected-files-list').innerHTML = '';
                    selectedFilesForUpload.clear();
                    
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    const pdfFileInput = document.getElementById('pdf-file');
                    if (pdfFileInput) {
                        pdfFileInput.value = '';
                    }
                    
                    // ì—…ë¡œë“œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                    updateSelectedCount();
                }
            });
            
            
            // ëª¨ë¸ ì„ íƒ ë³€ê²½ ì‹œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const modelSelect = document.getElementById('ollama-models');
            modelSelect.addEventListener('change', updateSelectedModelDisplay);
        });

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™”
        // Image modal functionality temporarily disabled
        
        // í‘œ í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥
        function toggleTableExpand(tableId) {
            const table = document.getElementById(tableId);
            const hiddenRows = table.querySelectorAll('.hidden-row');
            const expandIndicator = table.querySelector('.table-expand-indicator');
            const button = table.parentElement.querySelector('.btn-small');
            
            if (table.classList.contains('collapsed')) {
                // í™•ì¥
                hiddenRows.forEach(row => row.style.display = '');
                if (expandIndicator) expandIndicator.style.display = 'none';
                button.textContent = 'ì¶•ì†Œí•˜ê¸°';
                table.classList.remove('collapsed');
            } else {
                // ì¶•ì†Œ
                hiddenRows.forEach(row => row.style.display = 'none');
                if (expandIndicator) expandIndicator.style.display = '';
                button.textContent = 'ì „ì²´ ë³´ê¸°';
                table.classList.add('collapsed');
            }
        }
        
        // ESC í‚¤ ì´ë²¤íŠ¸ (ì´ë¯¸ì§€ ëª¨ë‹¬ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨)
        // document.addEventListener('keydown', function(e) {
        //     if (e.key === 'Escape') {
        //         closeImageModal();
        //     }
        // });
        
        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§(ë‹µë³€ì— ì ìš©)
        // marked.js CDN ì¶”ê°€
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
