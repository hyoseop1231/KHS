<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>OCR 기반 RAG 챗봇</h1>

        <div class="upload-section">
            <h2>PDF 파일 업로드</h2>
            <form id="upload-form">
                <label for="pdf-file">PDF 선택:</label>
                <input type="file" id="pdf-file" name="file" accept=".pdf" required>
                <button type="submit">업로드 및 처리</button>
            </form>
            <div id="upload-status" class="status-message"></div>
        </div>

        <div class="chat-section">
            <h2>챗봇과 대화하기</h2>
            <div id="chat-history">
                <!-- 채팅 메시지가 여기에 표시됩니다 -->
            </div>
            <input type="text" id="chat-input" placeholder="질문을 입력하세요...">
            <button id="send-button">전송</button>
            <div id="chat-status" class="status-message"></div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const pdfFile = document.getElementById('pdf-file');
        const uploadStatus = document.getElementById('upload-status');

        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatStatus = document.getElementById('chat-status');

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            uploadStatus.textContent = '파일을 업로드하고 처리 중입니다...';
            const formData = new FormData();
            formData.append('file', pdfFile.files[0]);

            try {
                const response = await fetch('/api/upload_pdf/', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (response.ok) {
                    uploadStatus.textContent = `성공: ${result.message || result.filename}`;
                } else {
                    uploadStatus.textContent = `오류: ${result.error || '알 수 없는 오류'}`;
                }
            } catch (error) {
                uploadStatus.textContent = `네트워크 오류: ${error.message}`;
            }
        });

        async function sendMessage() {
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage('user', query);
            chatInput.value = '';
            chatStatus.textContent = '답변을 기다리는 중...';

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });
                const result = await response.json();
                if (response.ok) {
                    appendMessage('bot', result.response);
                    chatStatus.textContent = '';
                } else {
                    appendMessage('bot', `오류: ${result.detail || '챗봇 응답 오류'}`);
                    chatStatus.textContent = `오류: ${result.detail || '챗봇 응답 오류'}`;
                }
            } catch (error) {
                appendMessage('bot', `네트워크 오류: ${error.message}`);
                chatStatus.textContent = `네트워크 오류: ${error.message}`;
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }
    </script>
</body>
</html>
