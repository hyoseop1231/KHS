<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¼ê¸°ìˆ ì´ì„œ ê¸°ë°˜ RAG ì±—ë´‡</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ì£¼ë¬¼ê¸°ìˆ ì´ì„œ ê¸°ë°˜ RAG ì±—ë´‡</h1>

        <div class="ollama-section">
            <h2>Ollama ìƒíƒœ ë° ëª¨ë¸ ì„ íƒ</h2>
            <div id="ollama-status">Ollama ìƒíƒœ: í™•ì¸ ì¤‘...</div>
            <label for="ollama-models">ì‚¬ìš©í•  ëª¨ë¸ ì„ íƒ:</label>
            <select id="ollama-models"></select>
        </div>

        <div class="upload-section">
            <h2>PDF íŒŒì¼ ì—…ë¡œë“œ</h2>
            <form id="upload-form">
                <label for="pdf-file">PDF ì„ íƒ:</label>
                <input type="file" id="pdf-file" name="file" accept=".pdf" required>
                <button type="submit">ì—…ë¡œë“œ ë° ì²˜ë¦¬</button>
            </form>
            <div id="upload-status" class="status-message"></div>
            <div id="progress-container" style="display:none; margin-top:10px;">
                <div id="progress-bar" style="height:20px; background:#e0e0e0; border-radius:10px; overflow:hidden;">
                    <div id="progress-bar-inner" style="height:100%; width:0%; background:#007bff; transition:width 0.3s;"></div>
                </div>
                <div id="progress-message" style="margin-top:8px; text-align:center;"></div>
            </div>
        </div>

        <div class="document-management-section">
            <h2>ë¬¸ì„œ ê´€ë¦¬</h2>
            <div style="margin-bottom:15px;">
                <button id="refresh-documents" style="margin-right:10px;">ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                <button id="storage-stats" style="margin-right:10px;">ì €ì¥ì†Œ í†µê³„</button>
                <button id="cleanup-files" style="margin-right:10px;">ê³ ì•„ íŒŒì¼ ì •ë¦¬</button>
                <button id="delete-all-documents" style="background:#dc3545; color:white;">ëª¨ë“  ë¬¸ì„œ ì‚­ì œ</button>
            </div>
            
            <div id="document-list" style="max-height:200px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:15px;">
                <!-- ë¬¸ì„œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div id="management-status" class="status-message"></div>
        </div>

        <div class="chat-section">
            <h2>ì±—ë´‡ê³¼ ëŒ€í™”í•˜ê¸°</h2>
            <div style="margin-bottom:10px;">
                <label for="document-select">ë¬¸ì„œ ì„ íƒ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥):</label>
                <select id="document-select" multiple size="4" style="min-width:220px;"></select>
                <span id="document-info" style="font-size:0.95em; color:#666; margin-left:8px;"></span>
                <div style="font-size:0.92em; color:#888; margin-top:4px;">Ctrl(ë˜ëŠ” âŒ˜)ì„ ëˆ„ë¥¸ ì±„ ì—¬ëŸ¬ ë¬¸ì„œë¥¼ ì„ íƒí•˜ê±°ë‚˜, 'ì „ì²´ ë¬¸ì„œ'ë¥¼ ì„ íƒí•˜ë©´ ëª¨ë“  ë¬¸ì„œì—ì„œ ê²€ìƒ‰í•©ë‹ˆë‹¤.</div>
            </div>
            
            <!-- Chat Progress Indicator -->
            <div id="chat-progress" class="chat-progress">
                <div class="chat-progress-steps">
                    <div class="progress-step" data-step="query">
                        <div class="progress-step-icon" data-step="1"></div>
                        <span>ì§ˆë¬¸ ë¶„ì„</span>
                    </div>
                    <div class="progress-step" data-step="embedding">
                        <div class="progress-step-icon" data-step="2"></div>
                        <span>ì„ë² ë”© ìƒì„±</span>
                    </div>
                    <div class="progress-step" data-step="search">
                        <div class="progress-step-icon" data-step="3"></div>
                        <span>ë¬¸ì„œ ê²€ìƒ‰</span>
                    </div>
                    <div class="progress-step" data-step="generate">
                        <div class="progress-step-icon" data-step="4"></div>
                        <span>ë‹µë³€ ìƒì„±</span>
                    </div>
                </div>
                <div class="progress-message" id="chat-progress-message">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
            
            <div id="chat-history">
                <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="send-button" class="btn btn-primary">ğŸ’¬ ì „ì†¡</button>
            </div>
            <div id="chat-status" class="status-message"></div>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('upload-form');
        const pdfFile = document.getElementById('pdf-file');
        const uploadStatus = document.getElementById('upload-status');

        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chatStatus = document.getElementById('chat-status');

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            uploadStatus.textContent = 'íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';
            const formData = new FormData();
            formData.append('file', pdfFile.files[0]);

            try {
                const response = await fetch('/api/upload_pdf/', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (response.ok) {
                    uploadStatus.textContent = `ì„±ê³µ: ${result.message || result.filename}`;
                    if(result.document_id) {
                        startProgressPolling(result.document_id);
                        // ë¬¸ì„œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            fetchDocumentList();
                        }, 2000);
                    }
                } else {
                    uploadStatus.textContent = `ì˜¤ë¥˜: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                }
            } catch (error) {
                uploadStatus.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            }
        });

        async function sendMessage() {
            const query = chatInput.value.trim();
            if (!query) return;

            appendMessage('user', query);
            chatInput.value = '';
            
            // Show progress indicator
            showChatProgress();
            
            // Disable send button
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading-spinner"></span>ìƒì„± ì¤‘...';

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query, model_name: getSelectedModel(), document_ids: getSelectedDocumentIds() }),
                });
                const result = await response.json();
                if (response.ok) {
                    // ë©€í‹°ëª¨ë‹¬ ì»¨í…íŠ¸ê°€ ìˆëŠ” ê²½ìš° ì´ë¯¸ì§€ì™€ í‘œë„ í‘œì‹œ
                    if (result.media_references && result.media_references.has_media) {
                        appendMultimodalMessage('bot', result);
                    } else {
                        appendMessage('bot', result.response, true);
                    }
                    
                    chatStatus.className = 'status-message status-success';
                    
                    // ì‚¬ìš©ëœ ì»¨í…íŠ¸ ìš”ì•½ í‘œì‹œ
                    const summary = result.content_summary;
                    if (summary) {
                        const summaryText = `í…ìŠ¤íŠ¸: ${summary.text_chunks || 0}ê°œ, ì´ë¯¸ì§€: ${summary.images || 0}ê°œ, í‘œ: ${summary.tables || 0}ê°œ`;
                        chatStatus.textContent = `âœ… ë‹µë³€ ìƒì„± ì™„ë£Œ (${summaryText})`;
                    } else {
                        chatStatus.textContent = 'âœ… ë‹µë³€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    }
                    
                    setTimeout(() => {
                        chatStatus.textContent = '';
                        chatStatus.className = 'status-message';
                    }, 5000);
                } else {
                    appendMessage('bot', `âŒ ì˜¤ë¥˜: ${result.detail || 'ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜'}`);
                    chatStatus.className = 'status-message status-error';
                    chatStatus.textContent = `âŒ ì˜¤ë¥˜: ${result.detail || 'ì±—ë´‡ ì‘ë‹µ ì˜¤ë¥˜'}`;
                }
            } catch (error) {
                appendMessage('bot', `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                chatStatus.className = 'status-message status-error';
                chatStatus.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            } finally {
                // Hide progress indicator and re-enable button
                hideChatProgress();
                sendButton.disabled = false;
                sendButton.innerHTML = 'ğŸ’¬ ì „ì†¡';
            }
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function appendMessage(sender, text, isMarkdown=false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            if(isMarkdown && window.marked) {
                messageDiv.innerHTML = window.marked.parse(text);
            } else {
                messageDiv.textContent = text;
            }
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }
        
        function appendMultimodalMessage(sender, result) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'bot-message', 'multimodal-message');
            
            // ë©”ì¸ ë‹µë³€ í…ìŠ¤íŠ¸
            const responseDiv = document.createElement('div');
            responseDiv.classList.add('response-text');
            if (window.marked) {
                responseDiv.innerHTML = window.marked.parse(result.response);
            } else {
                responseDiv.textContent = result.response;
            }
            messageDiv.appendChild(responseDiv);
            
            // ë¯¸ë””ì–´ ì»¨í…íŠ¸ ì¶”ê°€
            if (result.media_references && result.media_references.has_media) {
                const mediaDiv = document.createElement('div');
                mediaDiv.classList.add('media-content');
                
                // ì´ë¯¸ì§€ í‘œì‹œ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™”
                // Image display functionality temporarily disabled
                
                // ì°¸ì¡°ëœ í‘œ í‘œì‹œ
                if (result.media_references.tables && result.media_references.tables.length > 0) {
                    const tablesSection = document.createElement('div');
                    tablesSection.classList.add('referenced-tables');
                    tablesSection.innerHTML = '<h4>ğŸ“Š ì°¸ì¡°ëœ í‘œ</h4>';
                    
                    result.media_references.tables.forEach((table, tableIndex) => {
                        const tableContainer = document.createElement('div');
                        tableContainer.classList.add('table-reference');
                        tableContainer.setAttribute('data-table-number', tableIndex + 1);
                        
                        let tableHtml = `
                            <div class="table-info">
                                <span class="media-number">[í‘œ${tableIndex + 1}]</span>
                                <strong>ğŸ“„ ${table.filename}</strong> (í˜ì´ì§€ ${table.page})
                                <small>ì¶œì²˜: ${table.source}</small>
                            </div>
                        `;
                        
                        // í‘œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                        if (table.parsed_data && table.parsed_data.length > 0) {
                            const tableId = `table-${tableIndex}-${Date.now()}`;
                            tableHtml += `
                                <div class="table-data">
                                    <div class="table-controls">
                                        <button class="btn-small" onclick="toggleTableExpand('${tableId}')">ì „ì²´ ë³´ê¸°</button>
                                        <span class="table-size-info">${table.parsed_data.length}í–‰ í‘œ</span>
                                    </div>
                                    <table id="${tableId}" class="data-table collapsed">
                            `;
                            
                            // ì²˜ìŒì—ëŠ” 5í–‰ë§Œ í‘œì‹œ
                            const maxRows = 5;
                            for (let i = 0; i < Math.min(maxRows, table.parsed_data.length); i++) {
                                const row = table.parsed_data[i];
                                if (Array.isArray(row) && row.length > 0) {
                                    tableHtml += '<tr class="visible-row">';
                                    row.forEach((cell, cellIndex) => {
                                        const tag = i === 0 ? 'th' : 'td';
                                        const cellContent = String(cell).length > 50 ? 
                                            String(cell).substring(0, 50) + '...' : cell;
                                        tableHtml += `<${tag} title="${String(cell).replace(/"/g, '&quot;')}">${cellContent}</${tag}>`;
                                    });
                                    tableHtml += '</tr>';
                                }
                            }
                            
                            // ë‚˜ë¨¸ì§€ í–‰ë“¤ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€)
                            for (let i = maxRows; i < table.parsed_data.length; i++) {
                                const row = table.parsed_data[i];
                                if (Array.isArray(row) && row.length > 0) {
                                    tableHtml += '<tr class="hidden-row" style="display: none;">';
                                    row.forEach((cell, cellIndex) => {
                                        const cellContent = String(cell).length > 50 ? 
                                            String(cell).substring(0, 50) + '...' : cell;
                                        tableHtml += `<td title="${String(cell).replace(/"/g, '&quot;')}">${cellContent}</td>`;
                                    });
                                    tableHtml += '</tr>';
                                }
                            }
                            
                            if (table.parsed_data.length > maxRows) {
                                tableHtml += `<tr class="table-expand-indicator"><td colspan="100%" class="table-more">... +${table.parsed_data.length - maxRows}í–‰ ë” ë³´ê¸°</td></tr>`;
                            }
                            
                            tableHtml += '</table></div>';
                        } else if (table.content) {
                            // íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ì»¨í…íŠ¸ í‘œì‹œ
                            tableHtml += `
                                <div class="table-raw-content">
                                    <pre>${table.content}</pre>
                                </div>
                            `;
                        }
                        
                        // í‘œ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ ì¶”ê°€
                        if (table.path) {
                            const tableImageUrl = `/${table.path}`;
                            tableHtml += `
                                <div class="table-image-preview">
                                    <p><strong>í‘œ ì´ë¯¸ì§€:</strong></p>
                                    <img src="${tableImageUrl}" alt="Table from ${table.filename}" class="preview-table-image" 
                                         onclick="openImageModal('${tableImageUrl}', 'Table from ${table.filename}')" 
                                         onerror="this.style.display='none'">
                                </div>
                            `;
                        }
                        
                        tableContainer.innerHTML = tableHtml;
                        tablesSection.appendChild(tableContainer);
                    });
                    
                    mediaDiv.appendChild(tablesSection);
                }
                
                messageDiv.appendChild(mediaDiv);
            }
            
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // Chat progress functions
        function showChatProgress() {
            const progressEl = document.getElementById('chat-progress');
            const progressMessage = document.getElementById('chat-progress-message');
            const steps = ['query', 'embedding', 'search', 'generate'];
            
            progressEl.classList.add('active');
            
            // Reset all steps
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // Simulate progress steps
            let currentStep = 0;
            const stepInterval = setInterval(() => {
                if (currentStep > 0) {
                    const prevStep = document.querySelector(`[data-step="${steps[currentStep-1]}"]`);
                    prevStep.classList.remove('active');
                    prevStep.classList.add('completed');
                }
                
                if (currentStep < steps.length) {
                    const currentStepEl = document.querySelector(`[data-step="${steps[currentStep]}"]`);
                    currentStepEl.classList.add('active');
                    
                    const messages = {
                        'query': 'ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'embedding': 'ì§ˆë¬¸ì„ ë²¡í„°ë¡œ ë³€í™˜í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'search': 'ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...',
                        'generate': 'AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...'
                    };
                    
                    progressMessage.textContent = messages[steps[currentStep]];
                    currentStep++;
                } else {
                    clearInterval(stepInterval);
                }
            }, 800);
            
            // Store interval for cleanup
            progressEl.stepInterval = stepInterval;
        }
        
        function hideChatProgress() {
            const progressEl = document.getElementById('chat-progress');
            
            // Clear interval if running
            if (progressEl.stepInterval) {
                clearInterval(progressEl.stepInterval);
            }
            
            // Mark all steps as completed
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
            });
            
            // Hide after a brief delay
            setTimeout(() => {
                progressEl.classList.remove('active');
            }, 1000);
        }

        // Ollama ìƒíƒœ ë° ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function fetchOllamaStatusAndModels() {
            const statusEl = document.getElementById('ollama-status');
            // ìƒíƒœ
            try {
                const res = await fetch('/api/ollama/status');
                const data = await res.json();
                const status = data.status === 'running' ? 'âœ… ì‹¤í–‰ ì¤‘' : (data.status === 'not running' ? 'âŒ ì¤‘ì§€ë¨' : 'â“ ' + data.status);
                statusEl.textContent = 'Ollama ìƒíƒœ: ' + status;
                statusEl.className = 'status-display ' + (data.status === 'running' ? 'status-running' : 'status-stopped');
            } catch (e) {
                statusEl.textContent = 'Ollama ìƒíƒœ: âŒ í™•ì¸ ì‹¤íŒ¨';
                statusEl.className = 'status-display status-stopped';
            }
            // ëª¨ë¸ ëª©ë¡
            try {
                const res = await fetch('/api/ollama/models');
                const data = await res.json();
                const select = document.getElementById('ollama-models');
                select.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model;
                        opt.textContent = model;
                        select.appendChild(opt);
                    });
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'ëª¨ë¸ ì—†ìŒ';
                    select.appendChild(opt);
                }
            } catch (e) {
                const select = document.getElementById('ollama-models');
                select.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                select.appendChild(opt);
            }
        }
        function getSelectedModel() {
            const select = document.getElementById('ollama-models');
            return select.value;
        }
        // í˜ì´ì§€ ë¡œë“œ ì‹œ Ollama ìƒíƒœ/ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', fetchOllamaStatusAndModels);

        // í”„ë¡œê·¸ë ˆìŠ¤ë°” ë‹¨ê³„ë³„ ë§¤í•‘
        const progressSteps = [
            { step: 'OCR', percent: 20 },
            { step: 'Chunking', percent: 40 },
            { step: 'Embedding', percent: 60 },
            { step: 'Storing', percent: 80 },
            { step: 'Done', percent: 100 },
            { step: 'Error', percent: 100 },
        ];
        let progressInterval = null;
        function startProgressPolling(documentId) {
            const progressContainer = document.getElementById('progress-container');
            const progressBarInner = document.getElementById('progress-bar-inner');
            const progressMessage = document.getElementById('progress-message');
            progressContainer.style.display = 'block';
            progressBarInner.style.width = '0%';
            progressMessage.textContent = 'ì²˜ë¦¬ ëŒ€ê¸° ì¤‘...';
            if(progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(async () => {
                try {
                    const res = await fetch(`/api/upload_status/${documentId}`);
                    const data = await res.json();
                    const stepInfo = progressSteps.find(s => s.step === data.step) || { percent: 0 };
                    progressBarInner.style.width = stepInfo.percent + '%';
                    progressMessage.textContent = data.message || '';
                    if(data.step === 'Done') {
                        progressMessage.textContent = 'âœ… ' + data.message;
                        clearInterval(progressInterval);
                    } else if(data.step === 'Error') {
                        progressMessage.textContent = 'âŒ ' + data.message;
                        progressBarInner.style.background = '#dc3545';
                        clearInterval(progressInterval);
                    }
                } catch (e) {
                    progressMessage.textContent = 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨';
                }
            }, 1500);
        }

        // ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        async function fetchDocumentList() {
            try {
                const res = await fetch('/api/documents');
                const data = await res.json();
                
                // ì±„íŒ…ìš© ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
                const select = document.getElementById('document-select');
                const info = document.getElementById('document-info');
                select.innerHTML = '';
                // ì „ì²´ ë¬¸ì„œ ì˜µì…˜ ì¶”ê°€
                const allOpt = document.createElement('option');
                allOpt.value = '__ALL__';
                allOpt.textContent = 'ì „ì²´ ë¬¸ì„œ';
                select.appendChild(allOpt);
                
                // ë¬¸ì„œ ê´€ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                const documentList = document.getElementById('document-list');
                documentList.innerHTML = '';
                
                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(doc => {
                        // ì±„íŒ…ìš© ë“œë¡­ë‹¤ìš´
                        const opt = document.createElement('option');
                        opt.value = doc.document_id;
                        opt.textContent = `${doc.document_id} (${doc.chunk_count}ì²­í¬)`;
                        opt.setAttribute('data-preview', doc.first_chunk_preview || '');
                        select.appendChild(opt);
                        
                        // ë¬¸ì„œ ê´€ë¦¬ ëª©ë¡
                        const docDiv = document.createElement('div');
                        docDiv.className = 'document-item';
                        docDiv.innerHTML = `
                            <div class="document-info">
                                <div class="document-title">ğŸ“„ ${doc.document_id}</div>
                                <div class="text-muted">${doc.chunk_count} ì²­í¬</div>
                                <div class="document-preview">
                                    ${doc.first_chunk_preview ? doc.first_chunk_preview.slice(0, 100) + '...' : 'ë¯¸ë¦¬ë³´ê¸° ì—†ìŒ'}
                                </div>
                            </div>
                            <div class="document-actions">
                                <button onclick="deleteDocument('${doc.document_id}')" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.9rem;">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        `;
                        documentList.appendChild(docDiv);
                    });
                    // ì²« ë¬¸ì„œ ì •ë³´ í‘œì‹œ
                    info.textContent = data.documents[0].first_chunk_preview ? `ë¯¸ë¦¬ë³´ê¸°: ${data.documents[0].first_chunk_preview.slice(0, 60)}...` : '';
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'ì €ì¥ëœ ë¬¸ì„œ ì—†ìŒ';
                    select.appendChild(opt);
                    info.textContent = '';
                    
                    documentList.innerHTML = '<div class="text-center text-muted">ğŸ“­ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (e) {
                const select = document.getElementById('document-select');
                select.innerHTML = '';
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                select.appendChild(opt);
                document.getElementById('document-info').textContent = '';
                document.getElementById('document-list').innerHTML = '<div class="status-message status-error">âŒ ë¬¸ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>';
            }
        }
        function getSelectedDocumentIds() {
            const select = document.getElementById('document-select');
            const values = Array.from(select.selectedOptions).map(opt => opt.value);
            // ì „ì²´ ë¬¸ì„œ ì„ íƒ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜(ë°±ì—”ë“œì—ì„œ ì „ì²´ ê²€ìƒ‰)
            if (values.includes('__ALL__')) return [];
            return values;
        }

        // ë¬¸ì„œ ê´€ë¦¬ ê¸°ëŠ¥ë“¤
        async function deleteDocument(documentId) {
            if (!confirm(`ë¬¸ì„œ "${documentId}"ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âœ… ë¬¸ì„œ "${documentId}" ì‚­ì œ ì™„ë£Œ`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        async function deleteAllDocuments() {
            if (!confirm('ëª¨ë“  ë¬¸ì„œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = 
                        `âœ… ëª¨ë“  ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ (ë¬¸ì„œ: ${result.deleted_documents_count}ê°œ, íŒŒì¼: ${result.deleted_files_count}ê°œ)`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì‚­ì œ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        async function showStorageStats() {
            try {
                const response = await fetch('/api/storage/stats');
                const result = await response.json();
                
                if (response.ok) {
                    const stats = `ğŸ“Š ì €ì¥ì†Œ í†µê³„:\n` +
                        `íŒŒì¼: ${result.file_storage.total_files}ê°œ (${result.file_storage.total_size_mb}MB)\n` +
                        `ë¬¸ì„œ: ${result.vector_db.total_documents}ê°œ\n` +
                        `ì²­í¬: ${result.vector_db.total_chunks}ê°œ`;
                    alert(stats);
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        async function cleanupOrphanedFiles() {
            if (!confirm('ê³ ì•„ íŒŒì¼ë“¤ì„ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/documents/cleanup', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (response.ok) {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = 
                        `âœ… ì •ë¦¬ ì™„ë£Œ: ${result.cleaned_files_count}ê°œ íŒŒì¼ ì •ë¦¬ë¨`;
                    statusEl.className = 'status-message status-success';
                    fetchDocumentList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    const statusEl = document.getElementById('management-status');
                    statusEl.textContent = `âŒ ì •ë¦¬ ì‹¤íŒ¨: ${result.detail}`;
                    statusEl.className = 'status-message status-error';
                }
            } catch (error) {
                const statusEl = document.getElementById('management-status');
                statusEl.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                statusEl.className = 'status-message status-error';
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', () => {
            fetchOllamaStatusAndModels();
            fetchDocumentList();
            
            // ë¬¸ì„œ ê´€ë¦¬ ë²„íŠ¼ë“¤
            document.getElementById('refresh-documents').addEventListener('click', fetchDocumentList);
            document.getElementById('storage-stats').addEventListener('click', showStorageStats);
            document.getElementById('cleanup-files').addEventListener('click', cleanupOrphanedFiles);
            document.getElementById('delete-all-documents').addEventListener('click', deleteAllDocuments);
            
            // ë¬¸ì„œ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
            const docSelect = document.getElementById('document-select');
            const info = document.getElementById('document-info');
            docSelect.addEventListener('change', function() {
                const previews = Array.from(this.selectedOptions).map(opt => opt.getAttribute('data-preview') || '').filter(Boolean);
                info.textContent = previews.length > 0 ? `ë¯¸ë¦¬ë³´ê¸°: ${previews.map(p => p.slice(0, 60)).join(' | ')}...` : '';
            });
        });

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ê¸°ëŠ¥ ì„ì‹œ ë¹„í™œì„±í™”
        // Image modal functionality temporarily disabled
        
        // í‘œ í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥
        function toggleTableExpand(tableId) {
            const table = document.getElementById(tableId);
            const hiddenRows = table.querySelectorAll('.hidden-row');
            const expandIndicator = table.querySelector('.table-expand-indicator');
            const button = table.parentElement.querySelector('.btn-small');
            
            if (table.classList.contains('collapsed')) {
                // í™•ì¥
                hiddenRows.forEach(row => row.style.display = '');
                if (expandIndicator) expandIndicator.style.display = 'none';
                button.textContent = 'ì¶•ì†Œí•˜ê¸°';
                table.classList.remove('collapsed');
            } else {
                // ì¶•ì†Œ
                hiddenRows.forEach(row => row.style.display = 'none');
                if (expandIndicator) expandIndicator.style.display = '';
                button.textContent = 'ì „ì²´ ë³´ê¸°';
                table.classList.add('collapsed');
            }
        }
        
        // ESC í‚¤ ì´ë²¤íŠ¸ (ì´ë¯¸ì§€ ëª¨ë‹¬ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨)
        // document.addEventListener('keydown', function(e) {
        //     if (e.key === 'Escape') {
        //         closeImageModal();
        //     }
        // });
        
        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§(ë‹µë³€ì— ì ìš©)
        // marked.js CDN ì¶”ê°€
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(script);
    </script>
</body>
</html>
